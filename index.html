<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>SHADE RADIO ‚Äì Live</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="assets/logo.JPG">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SHADE RADIO">
  <meta name="theme-color" content="#000000">

  <!-- ‚úÖ AM√âLIORATION PERF : Remplacement Font Awesome par SVG inline (plus de 30Ko inutiles) -->
  <style>
    /* ===== VARIABLES CSS CENTRALIS√âES ===== */
    :root {
      --red:        #ff0000;
      --red-dark:   #8b0000;
      --red-mid:    #cc0000;
      --white-5:    rgba(255,255,255,0.05);
      --white-10:   rgba(255,255,255,0.10);
      --white-15:   rgba(255,255,255,0.15);
      --white-20:   rgba(255,255,255,0.20);
      --white-35:   rgba(255,255,255,0.35);
      --white-45:   rgba(255,255,255,0.45);
      --white-60:   rgba(255,255,255,0.60);
      --radius-btn: 50px;
      --blur-glass: blur(20px);
      --transition: 0.3s cubic-bezier(0.4,0,0.2,1);
    }

    * { box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    body {
      background: #000;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      overflow: hidden;
      padding-top: env(safe-area-inset-top, 10px);
      position: relative;
      perspective: 1200px;
    }
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background:
        radial-gradient(circle at 50% 40%, rgba(220,0,0,0.55), transparent 65%),
        radial-gradient(circle at 80% 90%, rgba(150,0,0,0.3), transparent 50%),
        radial-gradient(circle at 10% 20%, rgba(80,0,0,0.4), transparent 40%);
      z-index: -1;
      pointer-events: none;
    }

    #app { width: 100%; max-width: 420px; display: flex; flex-direction: column; align-items: center; }

    /* ===== TOP BAR ===== */
    .top-bar { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 15px; }
    .header-container { flex: 1; display: flex; align-items: center; background: var(--white-5); border: 1px solid var(--white-15); backdrop-filter: blur(10px); border-radius: 12px; overflow: hidden; }
    .live-badge { background: linear-gradient(90deg, var(--red), var(--red-dark)); color: #fff; font-size: 11px; font-weight: bold; padding: 10px 12px; animation: pulse 1.5s infinite; white-space: nowrap; }
    @keyframes pulse { 0% { box-shadow: inset 0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow: inset 0 0 0 10px rgba(255,255,255,0); } 100% { box-shadow: inset 0 0 0 0 rgba(255,255,255,0); } }
    .radio-ticker { flex: 1; overflow: hidden; padding: 8px 0; display: flex; }
    .radio-ticker span { display: inline-block; white-space: nowrap; padding-left: 100%; animation: scroll-text 12s linear infinite; color: #fff; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    @keyframes scroll-text { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

    /* ===== HAMBURGER ===== */
    .hamburger-btn { cursor: pointer; background: rgba(180,0,0,0.25); padding: 8px 10px; border-radius: 10px; backdrop-filter: blur(10px); border: 1px solid rgba(255,0,0,0.4); display: flex; flex-direction: column; justify-content: center; transition: var(--transition); box-shadow: 0 0 15px rgba(255,0,0,0.2); flex-shrink: 0; position: relative; }
    .hamburger-btn span { display: block; width: 22px; height: 2px; background: #fff; margin: 3px 0; border-radius: 2px; transition: 0.4s; }
    .hamburger-btn.open span:nth-child(1) { transform: rotate(-45deg) translate(-5px, 6px); }
    .hamburger-btn.open span:nth-child(2) { opacity: 0; }
    .hamburger-btn.open span:nth-child(3) { transform: rotate(45deg) translate(-5px, -6px); }

    /* ===== BADGE ===== */
    #chatBadge { position: absolute; top: -6px; right: -6px; background: var(--red); color: #fff; font-size: 10px; font-weight: bold; min-width: 18px; height: 18px; border-radius: 9px; display: none; align-items: center; justify-content: center; padding: 0 4px; border: 2px solid #000; z-index: 10; }
    @keyframes badge-pop { from { transform: scale(0); } to { transform: scale(1); } }
    .chat-menu-badge { background: var(--red); color: #fff; font-size: 10px; font-weight: bold; min-width: 18px; height: 18px; border-radius: 9px; display: none; align-items: center; justify-content: center; padding: 0 4px; margin-left: 6px; }

    /* ===== MAIN FRAME ===== */
    .main-frame { background: linear-gradient(180deg, rgba(120,0,0,0.18) 0%, rgba(255,255,255,0.03) 100%); backdrop-filter: var(--blur-glass); border-radius: 50px; padding: 25px 10px 220px 10px; margin-top: 5px; width: 92%; max-width: 340px; position: relative; border: 2px solid var(--white-20); box-shadow: 0 40px 80px rgba(0,0,0,0.9), inset 0 0 20px rgba(255,0,0,0.1); }
    .radio-logo { width: 290px; margin: 0 auto 5px; display: block; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.8)) drop-shadow(0 0 20px rgba(255,0,0,0.3)); animation: logo-swing 7s ease-in-out infinite; }
    @keyframes logo-swing { 0% { opacity: 0; transform: translateZ(400px) rotateY(90deg); filter: brightness(0) blur(10px); } 15% { opacity: 1; transform: translateZ(0) rotateY(0deg); filter: brightness(1); } 35% { transform: rotateY(20deg); filter: brightness(1.2); } 55% { transform: rotateY(-20deg); filter: brightness(1.2); } 75% { transform: rotateY(20deg); } 100% { transform: rotateY(0deg); filter: brightness(1); } }

    .player-container { position: relative; width: 100%; display: flex; justify-content: center; margin-top: 15px; }
    .player-container::after { content: ""; position: absolute; top: -8px; width: 221px; height: 221px; border-radius: 32px; background: linear-gradient(110deg, rgba(255,255,255,0) 40%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 60%); background-size: 200% 100%; pointer-events: none; z-index: 10; animation: gloss 4s linear infinite; }
    @keyframes gloss { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    #sc-player { background: transparent !important; transform: scale(0.65); transform-origin: top center; height: 300px; position: relative; z-index: 2; }
    #sc-player, #sc-player * { background: transparent !important; box-shadow: none !important; border: none !important; }
    #sc-player img { width: 100% !important; border-radius: 40px !important; box-shadow: 0 15px 35px rgba(0,0,0,0.8) !important; }
    #sc-player [class*="play-button"] { background: #001f3f !important; border-radius: 50% !important; border: 2px solid rgba(255,255,255,0.8) !important; box-shadow: 0 0 20px rgba(0,31,63,0.6), 0 0 10px rgba(255,255,255,0.2) !important; z-index: 5; transition: transform 0.2s; }
    #sc-player [class*="play-button"]:active { transform: scale(0.9); }

    /* ‚úÖ AM√âLIORATION PERF : Vinyl en pause quand onglet masqu√© (g√©r√© via JS + classe) */
    .custom-vinyl { position: absolute; top: 191px; width: 155px; height: 155px; z-index: 1; animation: vinyl-spin 6s linear infinite; filter: drop-shadow(0 0 15px rgba(0,0,0,0.6)); }
    .custom-vinyl.paused { animation-play-state: paused; }
    .radio-logo.paused { animation-play-state: paused; }
    @keyframes vinyl-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .ad-banner { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); width: 85%; background: var(--white-5); border: 1px solid var(--white-15); backdrop-filter: blur(10px); border-radius: 10px; overflow: hidden; display: flex; }
    .ad-ticker { flex: 1; padding: 7px 0; overflow: hidden; display: flex; }
    .ad-ticker span { display: inline-block; white-space: nowrap; padding-left: 100%; animation: scroll-text 14s linear infinite; color: #fff; font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

    /* ===== OVERLAYS ===== */
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; backdrop-filter: blur(25px) saturate(150%); -webkit-backdrop-filter: blur(25px) saturate(150%); background: rgba(0,0,0,0.35); display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; visibility: hidden; }
    .overlay.open { pointer-events: all; visibility: visible; }

    #menuOverlay { z-index: 200; gap: 15px; right: -100%; left: auto; width: 100%; transition: right 0.45s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0.45s; }
    #menuOverlay.open { right: 0; transition: right 0.45s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0s; }
    .menu-logo { width: 130px; margin-bottom: 20px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); opacity: 0; transform: scale(0.8); transition: opacity 0.5s 0.3s, transform 0.5s 0.3s cubic-bezier(0.175,0.885,0.32,1.275); }
    #menuOverlay.open .menu-logo { opacity: 1; transform: scale(1); }
    .menu-link { color: #fff; text-decoration: none; font-size: 17px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; padding: 15px 25px; border-radius: var(--radius-btn); border: 1px solid var(--white-20); background: var(--white-10); width: 80%; max-width: 300px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: background 0.2s, transform 0.2s; cursor: pointer; -webkit-user-select: none; user-select: none; }
    .menu-link:active { background: var(--white-20); transform: scale(0.96); }

    /* ===== SVG ICONS (remplace Font Awesome) ===== */
    .icon { width: 18px; height: 18px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; flex-shrink: 0; }

    /* ===== CHAT OVERLAY ===== */
    #chatOverlay { z-index: 300; justify-content: flex-start; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0.4s; padding-top: env(safe-area-inset-top, 10px); }
    #chatOverlay.open { transform: translateY(0); transition: transform 0.4s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0s; }
    .chat-header { width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.12); flex-shrink: 0; }
    .chat-header-left { display: flex; align-items: center; gap: 12px; }
    .chat-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, var(--red), var(--red-dark)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .chat-title { color: #fff; font-weight: bold; font-size: 15px; }
    .chat-sub { color: var(--white-45); font-size: 11px; margin-top: 2px; }
    .close-btn { background: var(--white-10); border: none; color: #fff; width: 34px; height: 34px; border-radius: 50%; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

    /* Pseudo screen */
    .pseudo-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px 20px; gap: 20px; width: 100%; }
    .pseudo-screen h2 { color: #fff; font-size: 22px; text-align: center; }
    .pseudo-screen p { color: var(--white-60); font-size: 14px; text-align: center; }
    .pseudo-input { width: 100%; max-width: 300px; padding: 14px 20px; border-radius: var(--radius-btn); border: 1px solid var(--white-20); background: var(--white-10); color: #fff; font-size: 16px; outline: none; text-align: center; transition: border-color 0.2s; }
    .pseudo-input:focus { border-color: var(--red); }
    .pseudo-input::placeholder { color: var(--white-35); }
    .pseudo-input.error { border-color: var(--red); animation: shake 0.3s; }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-8px)} 75%{transform:translateX(8px)} }
    .btn-join { background: linear-gradient(90deg, var(--red), var(--red-dark)); color: #fff; border: none; padding: 14px 44px; border-radius: var(--radius-btn); font-size: 16px; font-weight: bold; cursor: pointer; letter-spacing: 1px; box-shadow: 0 4px 20px rgba(255,0,0,0.4); transition: transform 0.2s, opacity 0.2s; }
    .btn-join:active { transform: scale(0.95); }
    .btn-join:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ‚úÖ AM√âLIORATION UX : bouton "Changer de pseudo" */
    .change-pseudo-btn { background: none; border: 1px solid var(--white-20); color: var(--white-45); padding: 6px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; margin-left: auto; }
    .change-pseudo-btn:hover { background: var(--white-10); color: #fff; }

    /* Chat body */
    .chat-body { flex: 1; display: none; flex-direction: column; overflow: hidden; width: 100%; }
    .chat-body.show { display: flex; }
    .messages-list { flex: 1; overflow-y: auto; padding: 14px 14px 8px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
    .messages-list::-webkit-scrollbar { display: none; }
    .expired-notice { text-align: center; color: var(--white-35); font-size: 11px; padding: 6px 0; font-style: italic; }

    /* Bubbles */
    .bubble-wrap { display: flex; flex-direction: column; max-width: 76%; animation: pop-in 0.22s ease; }
    .bubble-wrap.me { align-self: flex-end; align-items: flex-end; }
    .bubble-wrap.them { align-self: flex-start; align-items: flex-start; }
    @keyframes pop-in { from { opacity: 0; transform: scale(0.85) translateY(8px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    .bubble { padding: 9px 14px; border-radius: 18px; font-size: 14px; line-height: 1.45; word-break: break-word; position: relative; cursor: pointer; }
    .bubble-wrap.them .bubble { background: var(--white-10); border: 1px solid rgba(255,255,255,0.1); color: #fff; border-bottom-left-radius: 4px; }
    .bubble-wrap.me .bubble { background: linear-gradient(135deg, var(--red), var(--red-dark)); color: #fff; border-bottom-right-radius: 4px; }

    /* ‚úÖ AM√âLIORATION UX : √©tats d'envoi */
    .bubble-wrap.me .bubble.sending { opacity: 0.6; }
    .bubble-wrap.me .bubble.failed { background: linear-gradient(135deg, #555, #333); }
    .bubble-status { font-size: 10px; color: var(--white-35); margin-top: 2px; display: flex; align-items: center; gap: 4px; }
    .bubble-status.failed { color: #ff6b6b; cursor: pointer; }

    .bubble-pseudo { font-size: 11px; font-weight: bold; margin-bottom: 3px; }
    .bubble-time { font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 3px; text-align: right; }
    .reactions-bar { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
    .reaction-pill { display: flex; align-items: center; gap: 3px; background: var(--white-10); border: 1px solid var(--white-15); border-radius: 12px; padding: 2px 7px; font-size: 13px; cursor: pointer; transition: background 0.15s, transform 0.15s; user-select: none; }
    .reaction-pill:active { transform: scale(0.92); }
    .reaction-pill.mine { background: rgba(255,0,0,0.25); border-color: rgba(255,0,0,0.4); }
    .reaction-pill span.count { font-size: 11px; color: var(--white-60); }
    .emoji-picker { position: absolute; bottom: calc(100% + 6px); background: rgba(30,30,30,0.97); border: 1px solid var(--white-15); border-radius: 30px; padding: 6px 10px; display: none; gap: 8px; z-index: 50; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
    .emoji-picker.show { display: flex; }
    .bubble-wrap.me .emoji-picker { right: 0; }
    .bubble-wrap.them .emoji-picker { left: 0; }
    .emoji-pick-btn { font-size: 20px; cursor: pointer; transition: transform 0.15s; background: none; border: none; padding: 2px; }
    .emoji-pick-btn:active { transform: scale(1.35); }

    /* Typing */
    .typing-indicator { padding: 4px 14px 6px; min-height: 22px; color: var(--white-45); font-size: 12px; font-style: italic; flex-shrink: 0; }
    .typing-dots { display: inline-flex; gap: 3px; vertical-align: middle; margin-left: 4px; }
    .typing-dots span { width: 5px; height: 5px; background: var(--white-45); border-radius: 50%; animation: dot-bounce 1.2s infinite; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dot-bounce { 0%,80%,100% { transform: translateY(0); opacity: 0.4; } 40% { transform: translateY(-5px); opacity: 1; } }

    /* Input row */
    .chat-input-row { display: flex; align-items: center; gap: 10px; padding: 10px 14px; padding-bottom: max(10px, env(safe-area-inset-bottom)); border-top: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
    .chat-input { flex: 1; padding: 11px 16px; border-radius: 25px; border: 1px solid var(--white-15); background: var(--white-10); color: #fff; font-size: 15px; outline: none; transition: border-color 0.2s; }
    .chat-input:focus { border-color: rgba(255,0,0,0.4); }
    .chat-input::placeholder { color: var(--white-35); }
    .send-btn { background: linear-gradient(135deg, var(--red), var(--red-dark)); border: none; width: 42px; height: 42px; border-radius: 50%; color: #fff; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(255,0,0,0.4); transition: transform 0.2s, opacity 0.2s; flex-shrink: 0; }
    .send-btn:active { transform: scale(0.9); }
    .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* ‚úÖ AM√âLIORATION UX : Cooldown visuel */
    .cooldown-bar { height: 2px; background: rgba(255,0,0,0.3); width: 100%; transition: width 0.1s linear; display: none; }
    .cooldown-bar.active { display: block; }

    /* ===== HISTORIQUE ===== */
    #historyOverlay { z-index: 250; justify-content: flex-start; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0.4s; padding-top: env(safe-area-inset-top, 10px); }
    #historyOverlay.open { transform: translateY(0); transition: transform 0.4s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0s; }
    .history-header { width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.12); flex-shrink: 0; }
    .history-header-left { display: flex; align-items: center; gap: 12px; }
    .history-title { color: #fff; font-weight: bold; font-size: 15px; }
    .history-sub { color: var(--white-45); font-size: 11px; margin-top: 2px; }
    .history-body { flex: 1; overflow-y: auto; width: 100%; padding: 16px; display: flex; flex-direction: column; gap: 10px; }
    .history-body::-webkit-scrollbar { display: none; }
    .track-card { background: var(--white-5); border: 1px solid var(--white-10); border-radius: 16px; padding: 14px 18px; display: flex; align-items: center; gap: 14px; }
    .track-card.now-playing { border-color: rgba(255,0,0,0.45); background: rgba(255,0,0,0.08); }
    .track-index { font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.2); width: 20px; text-align: center; flex-shrink: 0; }
    .track-card.now-playing .track-index { color: #ff4444; }
    .now-dot { width: 10px; height: 10px; background: var(--red); border-radius: 50%; flex-shrink: 0; animation: pulse-dot 1.2s infinite; }
    @keyframes pulse-dot { 0%,100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.4); opacity: 0.6; } }
    .track-info { flex: 1; min-width: 0; }
    .track-now-label { font-size: 9px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: #ff4444; margin-bottom: 4px; }
    .track-title { color: #fff; font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .track-artist { color: var(--white-45); font-size: 12px; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .track-meta { display: flex; align-items: center; gap: 6px; margin-top: 5px; }
    .track-time { color: rgba(255,255,255,0.25); font-size: 10px; }
    .track-duration { color: rgba(255,255,255,0.2); font-size: 10px; }
    .history-loading { text-align: center; color: var(--white-35); font-size: 13px; padding: 40px 0; }
    .history-empty { text-align: center; color: rgba(255,255,255,0.3); font-size: 13px; padding: 40px 0; line-height: 1.6; }
    .history-refresh-btn { display: flex; align-items: center; justify-content: center; gap: 8px; background: var(--white-5); border: 1px solid rgba(255,255,255,0.12); border-radius: 25px; color: var(--white-45); font-size: 13px; padding: 10px; cursor: pointer; margin-top: 4px; transition: background 0.2s; }
    .history-refresh-btn:active { background: rgba(255,255,255,0.14); }

    /* ‚úÖ AM√âLIORATION UX : Toast de notification r√©seau */
    #toastContainer { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
    .toast { background: rgba(30,30,30,0.95); border: 1px solid var(--white-15); color: #fff; padding: 10px 18px; border-radius: 25px; font-size: 13px; white-space: nowrap; animation: toast-in 0.3s ease; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
    .toast.error { border-color: rgba(255,0,0,0.4); }
    .toast.success { border-color: rgba(0,200,100,0.4); }
    @keyframes toast-in { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
    @keyframes toast-out { from { opacity:1; } to { opacity:0; } }
  </style>
</head>
<body>

  <!-- ===== MENU OVERLAY ===== -->
  <div class="overlay" id="menuOverlay">
    <img src="assets/logo2.PNG" alt="SHADE RADIO" class="menu-logo">

    <a href="javascript:void(0)" class="menu-link" onclick="closeMenu(); openMail('titre')">
      <!-- ‚úÖ SVG inline : Ic√¥ne musique -->
      <svg class="icon" viewBox="0 0 24 24"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>
      Demander un titre
    </a>

    <a href="javascript:void(0)" class="menu-link" onclick="closeMenu(); openMail('pub')">
      <!-- ‚úÖ SVG inline : Ic√¥ne pub -->
      <svg class="icon" viewBox="0 0 24 24"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 3h-8l-2 4h12z"/></svg>
      Demande de pub
    </a>

    <a href="javascript:void(0)" class="menu-link" onclick="shareRadio(); closeMenu();">
      <!-- ‚úÖ SVG inline : Ic√¥ne partage -->
      <svg class="icon" viewBox="0 0 24 24"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
      Partager la radio
    </a>

    <a href="https://www.tiktok.com/@shaderadio" target="_blank" class="menu-link" onclick="closeMenu()">
      <!-- ‚úÖ SVG inline : Ic√¥ne TikTok -->
      <svg class="icon" viewBox="0 0 24 24" stroke="none" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-2.88 2.5 2.89 2.89 0 0 1-2.89-2.89 2.89 2.89 0 0 1 2.89-2.89c.28 0 .54.04.79.1V9.01a6.33 6.33 0 0 0-.79-.05 6.34 6.34 0 0 0-6.34 6.34 6.34 6.34 0 0 0 6.34 6.34 6.34 6.34 0 0 0 6.33-6.34V9.02a8.25 8.25 0 0 0 4.83 1.55V7.14a4.85 4.85 0 0 1-1.06-.45z"/></svg>
      Rejoins-nous sur TikTok
    </a>

    <a href="javascript:void(0)" class="menu-link" id="chatMenuLink" onclick="closeMenu(); setTimeout(openChat, 450);">
      <!-- ‚úÖ SVG inline : Ic√¥ne chat -->
      <svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      Chat Auditeurs
      <span class="chat-menu-badge" id="chatMenuBadge"></span>
    </a>

    <a href="javascript:void(0)" class="menu-link" onclick="closeMenu(); setTimeout(openHistory, 450);">
      <!-- ‚úÖ SVG inline : Ic√¥ne historique -->
      <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      Historique des titres
    </a>
  </div>

  <!-- ===== HISTORIQUE OVERLAY ===== -->
  <div class="overlay" id="historyOverlay">
    <div class="history-header">
      <div class="history-header-left">
        <div class="chat-avatar" style="font-size:16px;">üéµ</div>
        <div>
          <div class="history-title">Titres diffus√©s</div>
          <div class="history-sub">En cours + 4 derniers morceaux</div>
        </div>
      </div>
      <button class="close-btn" onclick="closeHistory()">‚úï</button>
    </div>
    <div class="history-body">
      <div class="history-loading" id="historyLoading">Chargement...</div>
      <div id="trackList"></div>
      <button class="history-refresh-btn" onclick="loadHistory()">
        <svg class="icon" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
        Actualiser
      </button>
    </div>
  </div>

  <!-- ===== CHAT OVERLAY ===== -->
  <div class="overlay" id="chatOverlay">
    <div class="chat-header">
      <div class="chat-header-left">
        <div class="chat-avatar">üéôÔ∏è</div>
        <div>
          <div class="chat-title">Chat Auditeurs</div>
          <div class="chat-sub" id="chatOnlineStatus">Shade Radio - Live</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <!-- ‚úÖ AM√âLIORATION UX : Bouton changer de pseudo -->
        <button class="change-pseudo-btn" id="changePseudoBtn" onclick="changePseudo()" style="display:none;">
          <svg class="icon" style="width:13px;height:13px;" viewBox="0 0 24 24"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>
          Pseudo
        </button>
        <button class="close-btn" onclick="closeChat()">‚úï</button>
      </div>
    </div>

    <div class="pseudo-screen" id="pseudoScreen">
      <div style="font-size:50px">üéß</div>
      <h2>Rejoins le chat !</h2>
      <p>Choisis un pseudo pour discuter avec les autres auditeurs.</p>
      <input class="pseudo-input" id="pseudoInput" type="text" placeholder="Ton pseudo..." maxlength="20" autocomplete="off"
        onkeydown="if(event.key==='Enter') joinChat()"
        oninput="this.classList.remove('error')">
      <button class="btn-join" id="joinBtn" onclick="joinChat()">Rejoindre</button>
    </div>

    <div class="chat-body" id="chatBody">
      <div class="messages-list" id="messagesList"></div>
      <div class="typing-indicator" id="typingIndicator"></div>
      <!-- ‚úÖ AM√âLIORATION UX : barre cooldown -->
      <div class="cooldown-bar" id="cooldownBar"></div>
      <div class="chat-input-row">
        <input class="chat-input" id="msgInput" type="text" placeholder="Ton message..." maxlength="200" autocomplete="off"
          onkeydown="if(event.key==='Enter') sendMessage()"
          oninput="onTyping()">
        <button class="send-btn" id="sendBtn" onclick="sendMessage()">
          <svg style="width:16px;height:16px;fill:none;stroke:white;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;" viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- ===== TOAST CONTAINER ===== -->
  <div id="toastContainer"></div>

  <!-- ===== MAIN APP ===== -->
  <div id="app">
    <div class="top-bar">
      <div class="header-container">
        <div class="live-badge">‚óè LIVE</div>
        <div class="radio-ticker">
          <span>100% Hip-Hop Classic - Shade Radio - Retrouvez-nous tous les soirs d√®s 21h sur TikTok</span>
        </div>
      </div>
      <div class="hamburger-btn" id="hamburgerBtn" onclick="toggleMenu()">
        <span></span><span></span><span></span>
        <div id="chatBadge"></div>
      </div>
    </div>
    <div class="main-frame">
      <img src="assets/logo2.PNG" alt="SHADE RADIO" class="radio-logo" id="radioLogo">
      <div class="player-container">
        <img src="assets/disque.PNG" class="custom-vinyl" id="vinylDisc" alt="Vinyl">
        <div id="sc-player" is="player" lang="fr"
          api-url="https://manager11.streamradio.fr:1700/api/v2"
          server-id="1" station-name="SHADE RADIO"
          imagecontainer="top" controlscontainer="bottom"
          :show-history="false" :show-share="false" :show-dj="false"
          :show-image="true" :show-bitrate="false"
          play-button-color="#ffffff" :progress-show="false" player-width="100%">
        </div>
      </div>
      <div class="ad-banner">
        <div class="ad-ticker">
          <span>Pour diffuser votre publicit√©, contactez nous via l'onglet demande de pub dans le menu.</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts StreamRadio player -->
  <script src="https://manager11.streamradio.fr:1700/media/static/js/sc_player/sc_player.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
  /* =====================================================================
     ‚úÖ CONFIG ‚Äî cl√© anon publique (S√âCURIT√â = activer RLS sur Supabase)
     ===================================================================== */
  var SUPA_URL   = 'https://rxhyapahjaypeudletdy.supabase.co';
  var SUPA_KEY   = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4aHlhcGFoamF5cGV1ZGxldGR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ5MjYsImV4cCI6MjA4NzYxMDkyNn0.tkvyJVBP1PW5UKh8Kewwft0L-iTZzddx6QXBiNbvB_0';
  var RADIO_BASE = 'https://manager11.streamradio.fr:1700';
  var sb         = window.supabase.createClient(SUPA_URL, SUPA_KEY);

  /* =====================================================================
     ‚úÖ √âTAT CENTRALIS√â ‚Äî fini les variables globales √©parpill√©es
     ===================================================================== */
  var App = {
    myPseudo:    localStorage.getItem('shade_pseudo') || null,
    chatSub:     null,
    reactionSub: null,
    typingChannel: null,
    typingUsers: {},       // { pseudo: timestamp }
    typingTimer: null,
    isTyping:    false,
    openPicker:  null,
    unreadCount: 0,
    EXPIRY_MS:   24 * 60 * 60 * 1000,
    // ‚úÖ ANTI-SPAM : cooldown d'envoi (ms)
    COOLDOWN_MS: 2000,
    lastSentAt:  0,
    cooldownRaf: null,
    EMOJI_MAP:   { fire:'üî•', heart:'‚ù§Ô∏è', joy:'üòÇ', thumbsup:'üëç', astonished:'üòÆ' },
    PSEUDO_COLORS: ['#ff6b6b','#ffa94d','#ffe066','#69db7c','#4dabf7','#da77f2','#f783ac','#63e6be','#a9e34b','#74c0fc'],
    historyAutoTimer: null,
    swReg: null,
    audioCtx: null,
    audioUnlocked: false
  };

  /* =====================================================================
     UTILITAIRES
     ===================================================================== */
  function esc(t) { return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

  function getPseudoColor(p) {
    var h = 0;
    for (var i = 0; i < p.length; i++) h = p.charCodeAt(i) + ((h << 5) - h);
    return App.PSEUDO_COLORS[Math.abs(h) % App.PSEUDO_COLORS.length];
  }

  function isRecent(d) { return (Date.now() - new Date(d).getTime()) < App.EXPIRY_MS; }

  /* =====================================================================
     ‚úÖ TOAST ‚Äî feedback r√©seau et erreurs
     ===================================================================== */
  function showToast(msg, type, duration) {
    var container = document.getElementById('toastContainer');
    var t = document.createElement('div');
    t.className = 'toast' + (type ? ' ' + type : '');
    t.textContent = msg;
    container.appendChild(t);
    setTimeout(function() {
      t.style.animation = 'toast-out 0.3s ease forwards';
      setTimeout(function() { if (t.parentNode) t.parentNode.removeChild(t); }, 300);
    }, duration || 3000);
  }

  /* =====================================================================
     ‚úÖ AM√âLIORATION PERF : Pause animations quand onglet masqu√©
     ===================================================================== */
  document.addEventListener('visibilitychange', function() {
    var vinyl = document.getElementById('vinylDisc');
    var logo  = document.getElementById('radioLogo');
    if (document.hidden) {
      if (vinyl) vinyl.classList.add('paused');
      if (logo)  logo.classList.add('paused');
    } else {
      if (vinyl) vinyl.classList.remove('paused');
      if (logo)  logo.classList.remove('paused');
    }
  });

  /* =====================================================================
     AUDIO UNLOCK + NOTIF
     ===================================================================== */
  function getAudioCtx() {
    if (!App.audioCtx) App.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    return App.audioCtx;
  }
  function unlockAudio() {
    if (App.audioUnlocked) return;
    try {
      var ctx = getAudioCtx(), buf = ctx.createBuffer(1,1,22050), src = ctx.createBufferSource();
      src.buffer = buf; src.connect(ctx.destination); src.start(0);
      ctx.resume().then(function() { App.audioUnlocked = true; }).catch(function(){});
    } catch(e) {}
  }
  function playNotifSound() {
    try {
      var ctx = getAudioCtx();
      function doPlay() {
        [880, 1100].forEach(function(f, i) {
          var o = ctx.createOscillator(), g = ctx.createGain();
          o.connect(g); g.connect(ctx.destination);
          o.type = 'sine';
          var t = ctx.currentTime + i * 0.15;
          o.frequency.setValueAtTime(f, t);
          g.gain.setValueAtTime(0.0001, t);
          g.gain.linearRampToValueAtTime(0.4, t + 0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, t + 0.4);
          o.start(t); o.stop(t + 0.41);
        });
      }
      if (ctx.state === 'suspended') ctx.resume().then(doPlay).catch(function(){});
      else doPlay();
    } catch(e) {}
  }

  /* =====================================================================
     BADGE
     ===================================================================== */
  function showBadge(n) {
    var b = document.getElementById('chatBadge'), mb = document.getElementById('chatMenuBadge');
    if (n > 0) {
      var l = n > 99 ? '99+' : String(n);
      b.textContent = l; mb.textContent = l;
      b.style.display = 'flex'; mb.style.display = 'flex';
      b.style.animation = 'none'; b.offsetHeight;
      b.style.animation = 'badge-pop 0.3s cubic-bezier(0.175,0.885,0.32,1.275)';
    } else {
      b.style.display = 'none'; mb.style.display = 'none';
    }
  }
  function resetBadge() { App.unreadCount = 0; showBadge(0); }

  /* =====================================================================
     MENU
     ===================================================================== */
  function openMail(type) {
    var email = 'shaderadiolive@gmail.com';
    var subject, body;
    if (type === 'titre') {
      subject = 'DEMANDE DE TITRE';
      body = 'ARTISTE:\n\nTITRE:';
    } else {
      subject = 'DEMANDE DE PUB';
      body = "J'aimerais faire la promo pub de ....";
    }
    var link = 'mailto:' + email + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
    window.location.href = link;
  }

  function toggleMenu() {
    var m = document.getElementById('menuOverlay'), b = document.getElementById('hamburgerBtn');
    if (m.classList.contains('open')) { m.classList.remove('open'); b.classList.remove('open'); }
    else { m.classList.add('open'); b.classList.add('open'); }
  }
  function closeMenu() {
    document.getElementById('menuOverlay').classList.remove('open');
    document.getElementById('hamburgerBtn').classList.remove('open');
  }
  function shareRadio() {
    if (navigator.share) navigator.share({ title: 'SHADE RADIO', text: '√âcoute SHADE RADIO !', url: window.location.href });
  }

  /* =====================================================================
     HISTORIQUE
     ===================================================================== */
  function openHistory() {
    document.getElementById('historyOverlay').classList.add('open');
    loadHistory();
    // ‚úÖ AM√âLIORATION : auto-refresh toutes les 30s
    App.historyAutoTimer = setInterval(loadHistory, 30000);
  }
  function closeHistory() {
    document.getElementById('historyOverlay').classList.remove('open');
    if (App.historyAutoTimer) { clearInterval(App.historyAutoTimer); App.historyAutoTimer = null; }
  }

  async function loadHistory() {
    var loading = document.getElementById('historyLoading');
    var tl      = document.getElementById('trackList');
    loading.style.display = 'block';
    tl.innerHTML = '';
    var data = null;
    var endpoints = [
      '/api/v2/history/?server_id=1',
      '/api/v2/history/',
      '/api/v2/lastplayed/?server_id=1',
      '/api/v2/lastplayed/'
    ];
    for (var ei = 0; ei < endpoints.length; ei++) {
      try {
        var res  = await fetch(RADIO_BASE + endpoints[ei], { signal: AbortSignal.timeout(5000) });
        var json = await res.json();
        if (Array.isArray(json)              && json.length)          { data = json;         break; }
        if (json && Array.isArray(json.data)    && json.data.length)   { data = json.data;    break; }
        if (json && Array.isArray(json.tracks)  && json.tracks.length) { data = json.tracks;  break; }
        if (json && Array.isArray(json.history) && json.history.length){ data = json.history; break; }
      } catch(e) {}
    }
    loading.style.display = 'none';
    if (!data || !data.length) {
      tl.innerHTML = '<div class="history-empty">Aucun titre disponible pour le moment.<br>La radio est peut-√™tre en pause.</div>';
      return;
    }
    renderTracks(data.slice(0, 5).map(function(t) {
      return {
        title:    t.title  || t.name   || 'Titre inconnu',
        artist:   t.artist || t.author || 'Artiste inconnu',
        dateStr:  t.start_time || t.played_at || t.date || null,
        duration: t.track_length_formatted || t.duration || null
      };
    }));
  }

  function renderTracks(tracks) {
    var tl = document.getElementById('trackList');
    tl.innerHTML = '';
    tracks.forEach(function(t, i) {
      var isNow = (i === 0);
      var card  = document.createElement('div');
      card.className = 'track-card' + (isNow ? ' now-playing' : '');
      var indexEl = document.createElement('div');
      if (isNow) { indexEl.className = 'now-dot'; }
      else { indexEl.className = 'track-index'; indexEl.textContent = i + 1; }
      var info = document.createElement('div');
      info.className = 'track-info';
      if (isNow) { var lbl = document.createElement('div'); lbl.className = 'track-now-label'; lbl.textContent = '‚ñ∂ En cours'; info.appendChild(lbl); }
      var titleEl = document.createElement('div'); titleEl.className = 'track-title'; titleEl.textContent = t.title;
      var artistEl = document.createElement('div'); artistEl.className = 'track-artist'; artistEl.textContent = t.artist;
      var meta = document.createElement('div'); meta.className = 'track-meta';
      if (t.dateStr) { var timeEl = document.createElement('span'); timeEl.className = 'track-time'; timeEl.textContent = timeAgo(t.dateStr); meta.appendChild(timeEl); }
      if (t.duration) { var durEl = document.createElement('span'); durEl.className = 'track-duration'; durEl.textContent = (t.dateStr ? '¬∑ ' : '') + t.duration; meta.appendChild(durEl); }
      info.appendChild(titleEl); info.appendChild(artistEl);
      if (meta.children.length) info.appendChild(meta);
      card.appendChild(indexEl); card.appendChild(info); tl.appendChild(card);
    });
  }

  function timeAgo(dateStr) {
    var diff = Math.floor((Date.now() - new Date(dateStr).getTime()) / 1000);
    if (isNaN(diff) || diff < 0) return 'en cours';
    if (diff < 60)    return '√† l\'instant';
    if (diff < 3600)  return Math.floor(diff / 60) + ' min';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h';
    return Math.floor(diff / 86400) + 'j';
  }

  /* =====================================================================
     CHAT ‚Äî OUVERTURE / FERMETURE
     ===================================================================== */
  function openChat() {
    document.getElementById('chatOverlay').classList.add('open');
    resetBadge();
    if (App.myPseudo) showMessages();
    else {
      document.getElementById('pseudoScreen').style.display = 'flex';
      document.getElementById('chatBody').classList.remove('show');
      document.getElementById('changePseudoBtn').style.display = 'none';
    }
  }
  function closeChat() {
    document.getElementById('chatOverlay').classList.remove('open');
    stopTyping();
  }

  /* ‚úÖ AM√âLIORATION : Changer de pseudo */
  function changePseudo() {
    App.myPseudo = null;
    localStorage.removeItem('shade_pseudo');
    document.getElementById('pseudoScreen').style.display = 'flex';
    document.getElementById('chatBody').classList.remove('show');
    document.getElementById('changePseudoBtn').style.display = 'none';
    document.getElementById('pseudoInput').value = '';
    stopTyping();
  }

  function joinChat() {
    var input = document.getElementById('pseudoInput');
    var joinBtn = document.getElementById('joinBtn');
    var p = input.value.trim();
    // ‚úÖ VALIDATION : pseudo non vide, pas de caract√®res sp√©ciaux dangereux
    if (!p || p.length < 2) {
      input.classList.add('error');
      showToast('Le pseudo doit faire au moins 2 caract√®res.', 'error');
      input.focus();
      return;
    }
    if (p.length > 20) {
      input.classList.add('error');
      showToast('Pseudo trop long (max 20 caract√®res).', 'error');
      return;
    }
    App.myPseudo = p;
    localStorage.setItem('shade_pseudo', p);
    joinBtn.disabled = true;
    showMessages();
    joinBtn.disabled = false;
  }

  function showMessages() {
    document.getElementById('pseudoScreen').style.display = 'none';
    document.getElementById('chatBody').classList.add('show');
    document.getElementById('changePseudoBtn').style.display = 'flex';
    loadMessages();
    if (!App.chatSub)    subscribeMessages();
    if (!App.reactionSub) subscribeReactions();
    if (!App.typingChannel) subscribeTyping();
  }

  /* =====================================================================
     MESSAGES ‚Äî CHARGEMENT
     ===================================================================== */
  async function loadMessages() {
    var since = new Date(Date.now() - App.EXPIRY_MS).toISOString();
    try {
      var res = await sb.from('messages').select('*').gte('created_at', since).order('created_at', { ascending: true }).limit(200);
      if (res.error) throw res.error;
      var list = document.getElementById('messagesList');
      list.innerHTML = '';
      if (!res.data.length) {
        var n = document.createElement('div');
        n.className = 'expired-notice';
        n.textContent = 'Aucun message r√©cent. Soyez le premier √† √©crire !';
        list.appendChild(n); return;
      }
      var ids = res.data.map(function(m) { return m.id; });
      var rRes = await sb.from('reactions').select('*').in('message_id', ids);
      var rMap = {};
      if (rRes.data) rRes.data.forEach(function(r) { if (!rMap[r.message_id]) rMap[r.message_id] = []; rMap[r.message_id].push(r); });
      res.data.forEach(function(msg) { renderBubble(msg, rMap[msg.id] || []); });
      scrollBottom();
    } catch(e) {
      showToast('Impossible de charger les messages.', 'error');
    }
  }

  /* =====================================================================
     MESSAGES ‚Äî ENVOI
     ===================================================================== */
  async function sendMessage() {
    var input   = document.getElementById('msgInput');
    var sendBtn = document.getElementById('sendBtn');
    var message = input.value.trim();
    if (!message || !App.myPseudo) return;

    // ‚úÖ ANTI-SPAM : cooldown c√¥t√© client
    var now     = Date.now();
    var elapsed = now - App.lastSentAt;
    if (elapsed < App.COOLDOWN_MS) {
      showToast('Attends un instant avant d\'envoyer un autre message.', 'error', 1500);
      animateCooldown(App.COOLDOWN_MS - elapsed);
      return;
    }

    // ‚úÖ VALIDATION c√¥t√© client : message non vide
    if (message.length > 200) {
      showToast('Message trop long (max 200 caract√®res).', 'error');
      return;
    }

    input.value = '';
    stopTyping();
    App.lastSentAt = now;
    sendBtn.disabled = true;

    // ‚úÖ AM√âLIORATION UX : message optimiste (affich√© avant confirmation serveur)
    var tempId   = 'temp-' + now;
    var tempMsg  = { id: tempId, pseudo: App.myPseudo, message: message, created_at: new Date().toISOString(), _pending: true };
    renderBubble(tempMsg, []);
    scrollBottom();
    animateCooldown(App.COOLDOWN_MS);

    try {
      var res = await sb.from('messages').insert([{ pseudo: App.myPseudo, message: message }]);
      if (res.error) throw res.error;
      // Supprime la bulle temporaire (le realtime va l'ajouter correctement)
      var tempEl = document.querySelector('[data-msg-id="' + tempId + '"]');
      if (tempEl) tempEl.parentNode.removeChild(tempEl);
    } catch(e) {
      // ‚úÖ AM√âLIORATION UX : affiche erreur sur la bulle et permet de r√©essayer
      var tempEl = document.querySelector('[data-msg-id="' + tempId + '"]');
      if (tempEl) {
        var bubble = tempEl.querySelector('.bubble');
        if (bubble) bubble.classList.add('failed');
        var status = tempEl.querySelector('.bubble-status');
        if (status) { status.className = 'bubble-status failed'; status.textContent = '‚ö† √âchec ‚Äî cliquer pour r√©essayer'; status.onclick = function() { input.value = message; tempEl.parentNode.removeChild(tempEl); }; }
      }
      showToast('√âchec d\'envoi. V√©rifiez votre connexion.', 'error');
    } finally {
      setTimeout(function() { sendBtn.disabled = false; }, App.COOLDOWN_MS);
    }
  }

  /* ‚úÖ ANTI-SPAM : animation barre cooldown */
  function animateCooldown(duration) {
    var bar = document.getElementById('cooldownBar');
    if (!bar) return;
    bar.classList.add('active');
    bar.style.width = '100%';
    var start = Date.now();
    if (App.cooldownRaf) cancelAnimationFrame(App.cooldownRaf);
    function step() {
      var elapsed = Date.now() - start;
      var pct = Math.max(0, 100 - (elapsed / duration) * 100);
      bar.style.width = pct + '%';
      if (pct > 0) { App.cooldownRaf = requestAnimationFrame(step); }
      else { bar.classList.remove('active'); bar.style.width = '100%'; }
    }
    App.cooldownRaf = requestAnimationFrame(step);
  }

  /* =====================================================================
     SUBSCRIPTIONS REALTIME
     ===================================================================== */
  function subscribeMessages() {
    App.chatSub = sb.channel('chat-messages')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, function(p) {
        var msg = p.new;
        if (!isRecent(msg.created_at)) return;
        if (document.getElementById('chatOverlay').classList.contains('open')) {
          // N'ajoute pas si la bulle optimiste existe d√©j√†
          renderBubble(msg, []);
          scrollBottom();
        } else if (msg.pseudo !== App.myPseudo) {
          App.unreadCount++;
          showBadge(App.unreadCount);
          playNotifSound();
          notifyViaSW(msg.pseudo, msg.message);
        }
      }).subscribe();
  }

  function subscribeReactions() {
    App.reactionSub = sb.channel('chat-reactions')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'reactions' }, function(p) {
        var id = p.new ? p.new.message_id : (p.old ? p.old.message_id : null);
        if (id) refreshReactions(id);
      }).subscribe();
  }

  /* =====================================================================
     TYPING ‚Äî via Broadcast
     ===================================================================== */
  function subscribeTyping() {
    App.typingChannel = sb.channel('shade-typing-broadcast', { config: { broadcast: { self: false } } });
    App.typingChannel
      .on('broadcast', { event: 'typing' }, function(payload) {
        var p = payload.payload;
        if (!p || !p.pseudo || p.pseudo === App.myPseudo) return;
        if (p.active) { App.typingUsers[p.pseudo] = Date.now(); }
        else          { delete App.typingUsers[p.pseudo]; }
        renderTypingDisplay();
      })
      .subscribe();

    setInterval(function() {
      var now = Date.now(), changed = false;
      Object.keys(App.typingUsers).forEach(function(p) {
        if (now - App.typingUsers[p] > 4000) { delete App.typingUsers[p]; changed = true; }
      });
      if (changed) renderTypingDisplay();
    }, 1000);
  }

  function renderTypingDisplay() {
    var ind = document.getElementById('typingIndicator');
    if (!ind) return;
    var others = Object.keys(App.typingUsers);
    if (!others.length) { ind.innerHTML = ''; return; }
    var name = others.length === 1 ? others[0] : others.length + ' personnes';
    var verb = others.length === 1 ? ' est en train d\'√©crire' : ' sont en train d\'√©crire';
    ind.innerHTML = '<span style="font-weight:bold;color:rgba(255,255,255,0.6);">' + esc(name) + '</span>' + verb +
      '<span class="typing-dots"><span></span><span></span><span></span></span>';
  }

  function onTyping() {
    if (!App.myPseudo || !App.typingChannel) return;
    if (!App.isTyping) {
      App.isTyping = true;
      App.typingChannel.send({ type: 'broadcast', event: 'typing', payload: { pseudo: App.myPseudo, active: true } });
    }
    clearTimeout(App.typingTimer);
    App.typingTimer = setTimeout(stopTyping, 3000);
  }

  function stopTyping() {
    if (!App.myPseudo || !App.isTyping) return;
    App.isTyping = false;
    clearTimeout(App.typingTimer);
    if (App.typingChannel) {
      App.typingChannel.send({ type: 'broadcast', event: 'typing', payload: { pseudo: App.myPseudo, active: false } });
    }
  }

  /* =====================================================================
     R√âACTIONS
     ===================================================================== */
  function renderReactionsBar(bar, msgId, reactions) {
    if (!bar) return;
    bar.innerHTML = '';
    var counts = {}, mine = {};
    reactions.forEach(function(r) { counts[r.emoji] = (counts[r.emoji] || 0) + 1; if (r.pseudo === App.myPseudo) mine[r.emoji] = true; });
    Object.keys(counts).forEach(function(e) {
      var pill = document.createElement('div');
      pill.className = 'reaction-pill' + (mine[e] ? ' mine' : '');
      pill.innerHTML = App.EMOJI_MAP[e] + ' <span class="count">' + counts[e] + '</span>';
      pill.onclick = function(ev) { ev.stopPropagation(); toggleReaction(msgId, e); };
      bar.appendChild(pill);
    });
  }

  async function toggleReaction(msgId, emoji) {
    if (!App.myPseudo) return;
    try {
      var check = await sb.from('reactions').select('id').eq('message_id', msgId).eq('pseudo', App.myPseudo).eq('emoji', emoji);
      if (check.data && check.data.length) await sb.from('reactions').delete().eq('id', check.data[0].id);
      else await sb.from('reactions').insert([{ message_id: msgId, pseudo: App.myPseudo, emoji: emoji }]);
      refreshReactions(msgId);
    } catch(e) {
      showToast('Erreur lors de la r√©action.', 'error', 1500);
    }
  }

  async function refreshReactions(msgId) {
    try {
      var res = await sb.from('reactions').select('*').eq('message_id', msgId);
      if (res.error) return;
      var wrap = document.querySelector('[data-msg-id="' + msgId + '"]');
      if (!wrap) return;
      renderReactionsBar(wrap.querySelector('.reactions-bar'), msgId, res.data);
    } catch(e) {}
  }

  /* =====================================================================
     RENDU DES BULLES
     ===================================================================== */
  function renderBubble(msg, reactions) {
    var list  = document.getElementById('messagesList');
    var isMe  = msg.pseudo === App.myPseudo;
    var color = getPseudoColor(msg.pseudo);
    var time  = new Date(msg.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

    var wrap = document.createElement('div');
    wrap.className = 'bubble-wrap ' + (isMe ? 'me' : 'them');
    wrap.setAttribute('data-msg-id', msg.id);

    var picker = document.createElement('div');
    picker.className = 'emoji-picker';
    Object.keys(App.EMOJI_MAP).forEach(function(k) {
      var btn = document.createElement('button');
      btn.className = 'emoji-pick-btn';
      btn.textContent = App.EMOJI_MAP[k];
      btn.onclick = function(e) { e.stopPropagation(); closePicker(); toggleReaction(msg.id, k); };
      picker.appendChild(btn);
    });

    var bubble = document.createElement('div');
    bubble.className = 'bubble' + (msg._pending ? ' sending' : '');
    bubble.innerHTML =
      (!isMe ? '<div class="bubble-pseudo" style="color:' + color + ';">' + esc(msg.pseudo) + '</div>' : '') +
      '<div>' + esc(msg.message) + '</div>' +
      '<div class="bubble-time">' + time + '</div>';
    bubble.appendChild(picker);
    bubble.addEventListener('click', function(e) {
      e.stopPropagation();
      if (App.openPicker && App.openPicker !== picker) App.openPicker.classList.remove('show');
      picker.classList.toggle('show');
      App.openPicker = picker.classList.contains('show') ? picker : null;
    });

    // ‚úÖ AM√âLIORATION UX : indicateur d'√©tat pour les messages "moi"
    var status = document.createElement('div');
    status.className = 'bubble-status';
    status.textContent = msg._pending ? 'Envoi...' : '';

    var bar = document.createElement('div');
    bar.className = 'reactions-bar';
    if (reactions && reactions.length) renderReactionsBar(bar, msg.id, reactions);

    wrap.appendChild(bubble);
    if (isMe) wrap.appendChild(status);
    wrap.appendChild(bar);
    list.appendChild(wrap);
  }

  function closePicker() {
    if (App.openPicker) { App.openPicker.classList.remove('show'); App.openPicker = null; }
  }
  document.addEventListener('click', function() { closePicker(); });

  function scrollBottom() {
    var l = document.getElementById('messagesList');
    l.scrollTop = l.scrollHeight;
  }

  /* =====================================================================
     SERVICE WORKER + NOTIFICATIONS PUSH
     ===================================================================== */
  async function registerSW() {
    if (!('serviceWorker' in navigator)) return;
    try {
      App.swReg = await navigator.serviceWorker.register('/sw.js');
    } catch(e) { console.warn('[SW] √©chec :', e); }
  }

  async function requestNotifPermission() {
    if (!('Notification' in window)) return;
    if (Notification.permission === 'granted' || Notification.permission === 'denied') return;
    await Notification.requestPermission();
  }

  function notifyViaSW(pseudo, message) {
    if (!App.swReg || !App.swReg.active) return;
    if (Notification.permission !== 'granted') return;
    App.swReg.active.postMessage({ type: 'NEW_MESSAGE', pseudo: pseudo, message: message });
  }

  /* =====================================================================
     INIT
     ===================================================================== */
  registerSW();
  subscribeMessages();

  function onFirstGesture() {
    unlockAudio();
    requestNotifPermission();
    try { if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(function(){}); } catch(e) {}
  }

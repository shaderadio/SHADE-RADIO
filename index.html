<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>SHADE RADIO ‚Äì Live</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="assets/logo.JPG">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SHADE RADIO">
  <meta name="theme-color" content="#000000">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { background: #000; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; overflow: hidden; padding-top: env(safe-area-inset-top, 10px); position: relative; perspective: 1200px; }
    body::before { content: ""; position: fixed; inset: 0; background: radial-gradient(circle at 50% 40%, rgba(220,0,0,0.55), transparent 65%), radial-gradient(circle at 80% 90%, rgba(150,0,0,0.3), transparent 50%), radial-gradient(circle at 10% 20%, rgba(80,0,0,0.4), transparent 40%); z-index: -1; pointer-events: none; }
    #app { width: 100%; max-width: 420px; display: flex; flex-direction: column; align-items: center; }
    .top-bar { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 15px; }
    .header-container { flex: 1; display: flex; align-items: center; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 12px; overflow: hidden; }
    .live-badge { background: linear-gradient(90deg, #ff0000, #8b0000); color: #fff; font-size: 11px; font-weight: bold; padding: 10px 12px; animation: pulse 1.5s infinite; white-space: nowrap; }
    @keyframes pulse { 0% { box-shadow: inset 0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow: inset 0 0 0 10px rgba(255,255,255,0); } 100% { box-shadow: inset 0 0 0 0 rgba(255,255,255,0); } }
    .radio-ticker { flex: 1; overflow: hidden; padding: 8px 0; display: flex; }
    .radio-ticker span { display: inline-block; white-space: nowrap; padding-left: 100%; animation: scroll-text 12s linear infinite; color: #fff; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    @keyframes scroll-text { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    .hamburger-btn { cursor: pointer; background: rgba(180,0,0,0.25); padding: 8px 10px; border-radius: 10px; backdrop-filter: blur(10px); border: 1px solid rgba(255,0,0,0.4); display: flex; flex-direction: column; justify-content: center; transition: 0.3s; box-shadow: 0 0 15px rgba(255,0,0,0.2); flex-shrink: 0; position: relative; }
    .hamburger-btn span { display: block; width: 22px; height: 2px; background: #fff; margin: 3px 0; border-radius: 2px; transition: 0.4s; }
    .hamburger-btn.open span:nth-child(1) { transform: rotate(-45deg) translate(-5px, 6px); }
    .hamburger-btn.open span:nth-child(2) { opacity: 0; }
    .hamburger-btn.open span:nth-child(3) { transform: rotate(45deg) translate(-5px, -6px); }
    #chatBadge { position: absolute; top: -6px; right: -6px; background: #ff0000; color: #fff; font-size: 10px; font-weight: bold; min-width: 18px; height: 18px; border-radius: 9px; display: none; align-items: center; justify-content: center; padding: 0 4px; border: 2px solid #000; z-index: 10; }
    @keyframes badge-pop { from { transform: scale(0); } to { transform: scale(1); } }
    .chat-menu-badge { background: #ff0000; color: #fff; font-size: 10px; font-weight: bold; min-width: 18px; height: 18px; border-radius: 9px; display: none; align-items: center; justify-content: center; padding: 0 4px; margin-left: 6px; }
    .main-frame { background: linear-gradient(180deg, rgba(120,0,0,0.18) 0%, rgba(255,255,255,0.03) 100%); backdrop-filter: blur(20px); border-radius: 50px; padding: 25px 10px 220px 10px; margin-top: 5px; width: 92%; max-width: 340px; position: relative; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 40px 80px rgba(0,0,0,0.9), inset 0 0 20px rgba(255,0,0,0.1); }
    .radio-logo { width: 290px; margin: 0 auto 5px; display: block; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.8)) drop-shadow(0 0 20px rgba(255,0,0,0.3)); animation: logo-swing 7s ease-in-out infinite; }
    @keyframes logo-swing { 0% { opacity: 0; transform: translateZ(400px) rotateY(90deg); filter: brightness(0) blur(10px); } 15% { opacity: 1; transform: translateZ(0) rotateY(0deg); filter: brightness(1); } 35% { transform: rotateY(20deg); filter: brightness(1.2); } 55% { transform: rotateY(-20deg); filter: brightness(1.2); } 75% { transform: rotateY(20deg); } 100% { transform: rotateY(0deg); filter: brightness(1); } }
    .player-container { position: relative; width: 100%; display: flex; justify-content: center; margin-top: 15px; }
    .player-container::after { content: ""; position: absolute; top: -8px; width: 221px; height: 221px; border-radius: 32px; background: linear-gradient(110deg, rgba(255,255,255,0) 40%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 60%); background-size: 200% 100%; pointer-events: none; z-index: 10; animation: gloss 4s linear infinite; }
    @keyframes gloss { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    #sc-player { background: transparent !important; transform: scale(0.65); transform-origin: top center; height: 300px; position: relative; z-index: 2; }
    #sc-player, #sc-player * { background: transparent !important; box-shadow: none !important; border: none !important; }
    #sc-player img { width: 100% !important; border-radius: 40px !important; box-shadow: 0 15px 35px rgba(0,0,0,0.8) !important; }
    #sc-player [class*="play-button"] { background: #001f3f !important; border-radius: 50% !important; border: 2px solid rgba(255,255,255,0.8) !important; box-shadow: 0 0 20px rgba(0,31,63,0.6), 0 0 10px rgba(255,255,255,0.2) !important; z-index: 5; transition: transform 0.2s; }
    #sc-player [class*="play-button"]:active { transform: scale(0.9); }
    .custom-vinyl { position: absolute; top: 191px; width: 155px; height: 155px; z-index: 1; animation: vinyl-spin 6s linear infinite; filter: drop-shadow(0 0 15px rgba(0,0,0,0.6)); }
    @keyframes vinyl-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .ad-banner { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); width: 85%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 10px; overflow: hidden; display: flex; }
    .ad-ticker { flex: 1; padding: 7px 0; overflow: hidden; display: flex; }
    .ad-ticker span { display: inline-block; white-space: nowrap; padding-left: 100%; animation: scroll-text 14s linear infinite; color: #fff; font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }

    /* OVERLAYS */
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; backdrop-filter: blur(25px) saturate(150%); -webkit-backdrop-filter: blur(25px) saturate(150%); background: rgba(0,0,0,0.35); display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; visibility: hidden; }
    .overlay.open { pointer-events: all; visibility: visible; }
    #menuOverlay { z-index: 200; gap: 15px; right: -100%; left: auto; width: 100%; transition: right 0.45s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0.45s; }
    #menuOverlay.open { right: 0; transition: right 0.45s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0s; }
    .menu-logo { width: 130px; margin-bottom: 20px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); opacity: 0; transform: scale(0.8); transition: opacity 0.5s 0.3s, transform 0.5s 0.3s cubic-bezier(0.175,0.885,0.32,1.275); }
    #menuOverlay.open .menu-logo { opacity: 1; transform: scale(1); }
    .menu-link { color: #fff; text-decoration: none; font-size: 17px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; padding: 15px 25px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); width: 80%; max-width: 300px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: background 0.2s, transform 0.2s; cursor: pointer; -webkit-user-select: none; user-select: none; }
    .menu-link:active { background: rgba(255,255,255,0.2); transform: scale(0.96); }

    /* CHAT */
    #chatOverlay { z-index: 300; justify-content: flex-start; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0.4s; padding-top: env(safe-area-inset-top, 10px); }
    #chatOverlay.open { transform: translateY(0); transition: transform 0.4s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0s; }
    .chat-header { width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.12); flex-shrink: 0; }
    .chat-header-left { display: flex; align-items: center; gap: 12px; }
    .chat-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, #ff0000, #8b0000); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .chat-title { color: #fff; font-weight: bold; font-size: 15px; }
    .chat-sub { color: rgba(255,255,255,0.45); font-size: 11px; margin-top: 2px; }
    .close-btn { background: rgba(255,255,255,0.1); border: none; color: #fff; width: 34px; height: 34px; border-radius: 50%; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .pseudo-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px 20px; gap: 20px; width: 100%; }
    .pseudo-screen h2 { color: #fff; font-size: 22px; text-align: center; }
    .pseudo-screen p { color: rgba(255,255,255,0.55); font-size: 14px; text-align: center; }
    .pseudo-input { width: 100%; max-width: 300px; padding: 14px 20px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: #fff; font-size: 16px; outline: none; text-align: center; }
    .pseudo-input::placeholder { color: rgba(255,255,255,0.35); }
    .btn-join { background: linear-gradient(90deg, #ff0000, #8b0000); color: #fff; border: none; padding: 14px 44px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; letter-spacing: 1px; box-shadow: 0 4px 20px rgba(255,0,0,0.4); transition: transform 0.2s; }
    .btn-join:active { transform: scale(0.95); }
    .chat-body { flex: 1; display: none; flex-direction: column; overflow: hidden; width: 100%; }
    .chat-body.show { display: flex; }
    .messages-list { flex: 1; overflow-y: auto; padding: 14px 14px 8px; display: flex; flex-direction: column; gap: 10px; scroll-behavior: smooth; }
    .messages-list::-webkit-scrollbar { display: none; }
    .expired-notice { text-align: center; color: rgba(255,255,255,0.3); font-size: 11px; padding: 6px 0; font-style: italic; }
    .bubble-wrap { display: flex; flex-direction: column; max-width: 76%; animation: pop-in 0.22s ease; }
    .bubble-wrap.me { align-self: flex-end; align-items: flex-end; }
    .bubble-wrap.them { align-self: flex-start; align-items: flex-start; }
    @keyframes pop-in { from { opacity: 0; transform: scale(0.85) translateY(8px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    .bubble { padding: 9px 14px; border-radius: 18px; font-size: 14px; line-height: 1.45; word-break: break-word; position: relative; cursor: pointer; }
    .bubble-wrap.them .bubble { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.1); color: #fff; border-bottom-left-radius: 4px; }
    .bubble-wrap.me .bubble { background: linear-gradient(135deg, #ff0000, #8b0000); color: #fff; border-bottom-right-radius: 4px; }
    .bubble-pseudo { font-size: 11px; font-weight: bold; margin-bottom: 3px; }
    .bubble-time { font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 3px; text-align: right; }
    .reactions-bar { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
    .reaction-pill { display: flex; align-items: center; gap: 3px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 2px 7px; font-size: 13px; cursor: pointer; transition: background 0.15s, transform 0.15s; user-select: none; }
    .reaction-pill:active { transform: scale(0.92); }
    .reaction-pill.mine { background: rgba(255,0,0,0.25); border-color: rgba(255,0,0,0.4); }
    .reaction-pill span.count { font-size: 11px; color: rgba(255,255,255,0.7); }
    .emoji-picker { position: absolute; bottom: calc(100% + 6px); background: rgba(30,30,30,0.97); border: 1px solid rgba(255,255,255,0.15); border-radius: 30px; padding: 6px 10px; display: none; gap: 8px; z-index: 50; box-shadow: 0 4px 20px rgba(0,0,0,0.6); }
    .emoji-picker.show { display: flex; }
    .bubble-wrap.me .emoji-picker { right: 0; }
    .bubble-wrap.them .emoji-picker { left: 0; }
    .emoji-pick-btn { font-size: 20px; cursor: pointer; transition: transform 0.15s; background: none; border: none; padding: 2px; }
    .emoji-pick-btn:active { transform: scale(1.35); }
    .typing-indicator { padding: 4px 14px 6px; min-height: 22px; color: rgba(255,255,255,0.4); font-size: 12px; font-style: italic; flex-shrink: 0; }
    .typing-dots { display: inline-flex; gap: 3px; vertical-align: middle; margin-left: 4px; }
    .typing-dots span { width: 5px; height: 5px; background: rgba(255,255,255,0.4); border-radius: 50%; animation: dot-bounce 1.2s infinite; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dot-bounce { 0%,80%,100% { transform: translateY(0); opacity: 0.4; } 40% { transform: translateY(-5px); opacity: 1; } }
    .chat-input-row { display: flex; align-items: center; gap: 10px; padding: 10px 14px; padding-bottom: max(10px, env(safe-area-inset-bottom)); border-top: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
    .chat-input { flex: 1; padding: 11px 16px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.08); color: #fff; font-size: 15px; outline: none; }
    .chat-input::placeholder { color: rgba(255,255,255,0.35); }
    .send-btn { background: linear-gradient(135deg, #ff0000, #8b0000); border: none; width: 42px; height: 42px; border-radius: 50%; color: #fff; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(255,0,0,0.4); transition: transform 0.2s; flex-shrink: 0; }
    .send-btn:active { transform: scale(0.9); }

    /* HISTORIQUE */
    #historyOverlay { z-index: 250; justify-content: flex-start; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0.4s; padding-top: env(safe-area-inset-top, 10px); }
    #historyOverlay.open { transform: translateY(0); transition: transform 0.4s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0s; }
    .history-header { width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.12); flex-shrink: 0; }
    .history-header-left { display: flex; align-items: center; gap: 12px; }
    .history-title { color: #fff; font-weight: bold; font-size: 15px; }
    .history-sub { color: rgba(255,255,255,0.45); font-size: 11px; margin-top: 2px; }
    .history-body { flex: 1; overflow-y: auto; width: 100%; padding: 16px; display: flex; flex-direction: column; gap: 10px; }
    .history-body::-webkit-scrollbar { display: none; }

    /* Track cards ‚Äî version simplifi√©e sans pochettes */
    .track-card { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 14px 18px; display: flex; align-items: center; gap: 14px; }
    .track-card.now-playing { border-color: rgba(255,0,0,0.45); background: rgba(255,0,0,0.08); }
    .track-index { font-size: 13px; font-weight: bold; color: rgba(255,255,255,0.2); width: 20px; text-align: center; flex-shrink: 0; }
    .track-card.now-playing .track-index { color: #ff4444; }
    .now-dot { width: 10px; height: 10px; background: #ff0000; border-radius: 50%; flex-shrink: 0; animation: pulse-dot 1.2s infinite; }
    @keyframes pulse-dot { 0%,100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.4); opacity: 0.6; } }
    .track-info { flex: 1; min-width: 0; }
    .track-now-label { font-size: 9px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: #ff4444; margin-bottom: 4px; }
    .track-title { color: #fff; font-weight: bold; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .track-artist { color: rgba(255,255,255,0.45); font-size: 12px; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .track-meta { display: flex; align-items: center; gap: 6px; margin-top: 5px; }
    .track-time { color: rgba(255,255,255,0.25); font-size: 10px; }
    .track-duration { color: rgba(255,255,255,0.2); font-size: 10px; }
    .history-loading { text-align: center; color: rgba(255,255,255,0.35); font-size: 13px; padding: 40px 0; }
    .history-empty { text-align: center; color: rgba(255,255,255,0.3); font-size: 13px; padding: 40px 0; line-height: 1.6; }
    .history-refresh-btn { display: flex; align-items: center; justify-content: center; gap: 8px; background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.12); border-radius: 25px; color: rgba(255,255,255,0.5); font-size: 13px; padding: 10px; cursor: pointer; margin-top: 4px; transition: background 0.2s; }
    .history-refresh-btn:active { background: rgba(255,255,255,0.14); }
  </style>
</head>
<body>

  <!-- MENU OVERLAY -->
  <div class="overlay" id="menuOverlay">
    <img src="assets/logo2.PNG" alt="SHADE RADIO" class="menu-logo">
    <a href="/cdn-cgi/l/email-protection#e4978c8580819685808d8b888d9281a48389858d88ca878b89db9791868e818790d9a08189858a8081c48081c4908d909681c2868b809dd9a596908d979081c4dec4c1d4a0c1d4a5b08d909681c4dec4" class="menu-link" onclick="closeMenu()">
      <i class="fas fa-music"></i> Demander un titre
    </a>
    <a href="/cdn-cgi/l/email-protection#f88b90999c9d8a999c919794918e9db89f95999194d69b9795c78b8d9a929d9b8cc5bc9d9599969c9dd89c9dd8888d9a" class="menu-link" onclick="closeMenu()">
      <i class="fas fa-ad"></i> Demande de pub
    </a>
    <a href="javascript:void(0)" class="menu-link" onclick="shareRadio(); closeMenu();">
      <i class="fas fa-share-nodes"></i> Partager la radio
    </a>
    <a href="https://www.tiktok.com/@shaderadio" target="_blank" class="menu-link" onclick="closeMenu()">
      <i class="fab fa-tiktok"></i> Rejoins-nous sur TikTok
    </a>
    <a href="javascript:void(0)" class="menu-link" id="chatMenuLink" onclick="closeMenu(); setTimeout(openChat, 450);">
      <i class="fas fa-comments"></i> Chat Auditeurs
      <span class="chat-menu-badge" id="chatMenuBadge"></span>
    </a>
    <a href="javascript:void(0)" class="menu-link" onclick="closeMenu(); setTimeout(openHistory, 450);">
      <i class="fas fa-clock-rotate-left"></i> Historique des titres
    </a>
  </div>

  <!-- HISTORIQUE OVERLAY -->
  <div class="overlay" id="historyOverlay">
    <div class="history-header">
      <div class="history-header-left">
        <div class="chat-avatar" style="font-size:16px;">&#127925;</div>
        <div>
          <div class="history-title">Titres diffuses</div>
          <div class="history-sub">En cours + 4 derniers morceaux</div>
        </div>
      </div>
      <button class="close-btn" onclick="closeHistory()">&#10005;</button>
    </div>
    <div class="history-body">
      <div class="history-loading" id="historyLoading">Chargement...</div>
      <div id="trackList"></div>
      <button class="history-refresh-btn" onclick="loadHistory()">
        <i class="fas fa-rotate-right"></i> Actualiser
      </button>
    </div>
  </div>

  <!-- CHAT OVERLAY -->
  <div class="overlay" id="chatOverlay">
    <div class="chat-header">
      <div class="chat-header-left">
        <div class="chat-avatar">&#127897;</div>
        <div>
          <div class="chat-title">Chat Auditeurs</div>
          <div class="chat-sub">Shade Radio - Live</div>
        </div>
      </div>
      <button class="close-btn" onclick="closeChat()">&#10005;</button>
    </div>
    <div class="pseudo-screen" id="pseudoScreen">
      <div style="font-size:50px">&#127911;</div>
      <h2>Rejoins le chat !</h2>
      <p>Choisis un pseudo pour discuter avec les autres auditeurs.</p>
      <input class="pseudo-input" id="pseudoInput" type="text" placeholder="Ton pseudo..." maxlength="20" autocomplete="off" onkeydown="if(event.key==='Enter') joinChat()">
      <button class="btn-join" onclick="joinChat()">Rejoindre</button>
    </div>
    <div class="chat-body" id="chatBody">
      <div class="messages-list" id="messagesList"></div>
      <div class="typing-indicator" id="typingIndicator"></div>
      <div class="chat-input-row">
        <input class="chat-input" id="msgInput" type="text" placeholder="Ton message..." maxlength="200" autocomplete="off"
          onkeydown="if(event.key==='Enter') sendMessage()" oninput="onTyping()">
        <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app">
    <div class="top-bar">
      <div class="header-container">
        <div class="live-badge">&#9679; LIVE</div>
        <div class="radio-ticker">
          <span>100% Hip-Hop Classic - Shade Radio - Retrouvez-nous tous les soirs des 21h sur TikTok</span>
        </div>
      </div>
      <div class="hamburger-btn" id="hamburgerBtn" onclick="toggleMenu()">
        <span></span><span></span><span></span>
        <div id="chatBadge"></div>
      </div>
    </div>
    <div class="main-frame">
      <img src="assets/logo2.PNG" alt="SHADE RADIO" class="radio-logo">
      <div class="player-container">
        <img src="assets/disque.PNG" class="custom-vinyl" alt="Vinyl">
        <div id="sc-player" is="player" lang="fr"
          api-url="https://manager11.streamradio.fr:1700/api/v2"
          server-id="1" station-name="SHADE RADIO"
          imagecontainer="top" controlscontainer="bottom"
          :show-history="false" :show-share="false" :show-dj="false"
          :show-image="true" :show-bitrate="false"
          play-button-color="#ffffff" :progress-show="false" player-width="100%">
        </div>
      </div>
      <div class="ad-banner">
        <div class="ad-ticker">
          <span>Pour diffuser votre publicite, contactez nous via l'onglet demande de pub dans le menu.</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts StreamRadio player -->
  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script src="https://manager11.streamradio.fr:1700/media/static/js/sc_player/sc_player.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    var SUPA_URL   = 'https://rxhyapahjaypeudletdy.supabase.co';
    var SUPA_KEY   = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4aHlhcGFoamF5cGV1ZGxldGR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ5MjYsImV4cCI6MjA4NzYxMDkyNn0.tkvyJVBP1PW5UKh8Kewwft0L-iTZzddx6QXBiNbvB_0';
    var RADIO_BASE = 'https://manager11.streamradio.fr:1700';
    var sb = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    var myPseudo    = localStorage.getItem('shade_pseudo') || null;
    var chatSub     = null;
    var reactionSub = null;
    var typingSub   = null;
    var unreadCount = 0;
    var EXPIRY_MS   = 24 * 60 * 60 * 1000;
    var typingTimer = null;
    var isTyping    = false;
    var openPicker  = null;
    var EMOJI_MAP   = { fire:'üî•', heart:'‚ù§Ô∏è', joy:'üòÇ', thumbsup:'üëç', astonished:'üòÆ' };
    var PSEUDO_COLORS = ['#ff6b6b','#ffa94d','#ffe066','#69db7c','#4dabf7','#da77f2','#f783ac','#63e6be','#a9e34b','#74c0fc'];

    function getPseudoColor(p) {
      var h = 0;
      for (var i = 0; i < p.length; i++) h = p.charCodeAt(i) + ((h << 5) - h);
      return PSEUDO_COLORS[Math.abs(h) % PSEUDO_COLORS.length];
    }

    /* AUDIO */
    var audioCtx = null, audioUnlocked = false;
    function getAudioCtx() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); return audioCtx; }
    function unlockAudio() {
      if (audioUnlocked) return;
      try { var ctx = getAudioCtx(), buf = ctx.createBuffer(1,1,22050), src = ctx.createBufferSource(); src.buffer=buf; src.connect(ctx.destination); src.start(0); ctx.resume().then(function(){ audioUnlocked=true; }).catch(function(){}); } catch(e) {}
    }
    function playNotifSound() {
      try {
        var ctx = getAudioCtx();
        function doPlay() { [880,1100].forEach(function(f,i){ var o=ctx.createOscillator(),g=ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type='sine'; var t=ctx.currentTime+i*0.15; o.frequency.setValueAtTime(f,t); g.gain.setValueAtTime(0.0001,t); g.gain.linearRampToValueAtTime(0.4,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.4); o.start(t); o.stop(t+0.41); }); }
        if (ctx.state==='suspended') ctx.resume().then(doPlay).catch(function(){}); else doPlay();
      } catch(e) {}
    }

    /* BADGE */
    function showBadge(n) {
      var b=document.getElementById('chatBadge'), mb=document.getElementById('chatMenuBadge');
      if (n>0) { var l=n>99?'99+':String(n); b.textContent=l; mb.textContent=l; b.style.display='flex'; mb.style.display='flex'; b.style.animation='none'; b.offsetHeight; b.style.animation='badge-pop 0.3s cubic-bezier(0.175,0.885,0.32,1.275)'; }
      else { b.style.display='none'; mb.style.display='none'; }
    }
    function resetBadge() { unreadCount=0; showBadge(0); }

    /* MENU */
    function toggleMenu() { var m=document.getElementById('menuOverlay'),b=document.getElementById('hamburgerBtn'); if(m.classList.contains('open')){m.classList.remove('open');b.classList.remove('open');}else{m.classList.add('open');b.classList.add('open');} }
    function closeMenu() { document.getElementById('menuOverlay').classList.remove('open'); document.getElementById('hamburgerBtn').classList.remove('open'); }
    function shareRadio() { if(navigator.share) navigator.share({title:'SHADE RADIO',text:'Ecoute SHADE RADIO !',url:window.location.href}); }

    /* =====================
       HISTORIQUE ‚Äî appel direct API, pas de pochettes
    ===================== */
    function openHistory() {
      document.getElementById('historyOverlay').classList.add('open');
      loadHistory();
    }
    function closeHistory() {
      document.getElementById('historyOverlay').classList.remove('open');
    }

    async function loadHistory() {
      var loading = document.getElementById('historyLoading');
      var tl      = document.getElementById('trackList');
      loading.style.display = 'block';
      tl.innerHTML = '';

      var data = null;
      var endpoints = [
        '/api/v2/history/?server_id=1',
        '/api/v2/history/',
        '/api/v2/lastplayed/?server_id=1',
        '/api/v2/lastplayed/'
      ];

      for (var ei = 0; ei < endpoints.length; ei++) {
        try {
          var res  = await fetch(RADIO_BASE + endpoints[ei]);
          var json = await res.json();
          if (Array.isArray(json)            && json.length)         { data = json;        break; }
          if (json && Array.isArray(json.data)   && json.data.length)   { data = json.data;   break; }
          if (json && Array.isArray(json.tracks) && json.tracks.length) { data = json.tracks; break; }
          if (json && Array.isArray(json.history) && json.history.length) { data = json.history; break; }
        } catch(e) {}
      }

      loading.style.display = 'none';

      if (!data || !data.length) {
        tl.innerHTML = '<div class="history-empty">Aucun titre disponible pour le moment.<br>La radio est peut-etre en pause.</div>';
        return;
      }

      renderTracks(data.slice(0, 5).map(function(t) {
        return {
          title:   t.title  || t.name        || 'Titre inconnu',
          artist:  t.artist || t.author      || 'Artiste inconnu',
          dateStr: t.start_time || t.played_at || t.date || null,
          duration: t.track_length_formatted  || t.duration || null
        };
      }));
    }

    function renderTracks(tracks) {
      var tl = document.getElementById('trackList');
      tl.innerHTML = '';

      tracks.forEach(function(t, i) {
        var isNow = (i === 0);
        var card  = document.createElement('div');
        card.className = 'track-card' + (isNow ? ' now-playing' : '');

        /* Indicateur gauche : point rouge anim√© pour "en cours", num√©ro sinon */
        var indexEl = document.createElement('div');
        if (isNow) {
          indexEl.className = 'now-dot';
        } else {
          indexEl.className = 'track-index';
          indexEl.textContent = i + 1;
        }

        /* Infos */
        var info = document.createElement('div');
        info.className = 'track-info';

        if (isNow) {
          var lbl = document.createElement('div');
          lbl.className = 'track-now-label';
          lbl.textContent = '‚ñ∂ En cours';
          info.appendChild(lbl);
        }

        var titleEl = document.createElement('div');
        titleEl.className = 'track-title';
        titleEl.textContent = t.title || 'Titre inconnu';

        var artistEl = document.createElement('div');
        artistEl.className = 'track-artist';
        artistEl.textContent = t.artist || 'Artiste inconnu';

        var meta = document.createElement('div');
        meta.className = 'track-meta';

        if (t.dateStr) {
          var timeEl = document.createElement('span');
          timeEl.className = 'track-time';
          timeEl.textContent = timeAgo(t.dateStr);
          meta.appendChild(timeEl);
        }
        if (t.duration) {
          var durEl = document.createElement('span');
          durEl.className = 'track-duration';
          durEl.textContent = (t.dateStr ? '¬∑ ' : '') + t.duration;
          meta.appendChild(durEl);
        }

        info.appendChild(titleEl);
        info.appendChild(artistEl);
        if (meta.children.length) info.appendChild(meta);

        card.appendChild(indexEl);
        card.appendChild(info);
        tl.appendChild(card);
      });
    }

    function timeAgo(dateStr) {
      var diff = Math.floor((Date.now() - new Date(dateStr).getTime()) / 1000);
      if (isNaN(diff) || diff < 0) return 'en cours';
      if (diff < 60)    return 'a l\'instant';
      if (diff < 3600)  return Math.floor(diff / 60) + ' min';
      if (diff < 86400) return Math.floor(diff / 3600) + 'h';
      return Math.floor(diff / 86400) + 'j';
    }

    /* ===== CHAT ===== */
    function openChat() { document.getElementById('chatOverlay').classList.add('open'); resetBadge(); if(myPseudo) showMessages(); else { document.getElementById('pseudoScreen').style.display='flex'; document.getElementById('chatBody').classList.remove('show'); } }
    function closeChat() { document.getElementById('chatOverlay').classList.remove('open'); stopTyping(); }
    function joinChat() { var i=document.getElementById('pseudoInput'),p=i.value.trim(); if(!p){i.focus();return;} myPseudo=p; localStorage.setItem('shade_pseudo',p); showMessages(); }
    function showMessages() { document.getElementById('pseudoScreen').style.display='none'; document.getElementById('chatBody').classList.add('show'); loadMessages(); if(!chatSub) subscribeMessages(); if(!reactionSub) subscribeReactions(); if(!typingSub) subscribeTyping(); }
    function isRecent(d) { return (Date.now()-new Date(d).getTime())<EXPIRY_MS; }

    async function loadMessages() {
      var since=new Date(Date.now()-EXPIRY_MS).toISOString();
      var res=await sb.from('messages').select('*').gte('created_at',since).order('created_at',{ascending:true}).limit(200);
      if(res.error) return;
      var list=document.getElementById('messagesList'); list.innerHTML='';
      if(!res.data.length){var n=document.createElement('div');n.className='expired-notice';n.textContent='Aucun message recent. Soyez le premier a ecrire !';list.appendChild(n);return;}
      var ids=res.data.map(function(m){return m.id;});
      var rRes=await sb.from('reactions').select('*').in('message_id',ids);
      var rMap={};
      if(rRes.data) rRes.data.forEach(function(r){if(!rMap[r.message_id])rMap[r.message_id]=[];rMap[r.message_id].push(r);});
      res.data.forEach(function(msg){renderBubble(msg,rMap[msg.id]||[]);});
      scrollBottom();
    }

    function subscribeMessages() {
      chatSub=sb.channel('chat-messages').on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'},function(p){
        var msg=p.new; if(!isRecent(msg.created_at)) return;
        if(document.getElementById('chatOverlay').classList.contains('open')){renderBubble(msg,[]);scrollBottom();}
        else if(msg.pseudo!==myPseudo){unreadCount++;showBadge(unreadCount);playNotifSound();}
      }).subscribe();
    }
    function subscribeReactions() {
      reactionSub=sb.channel('chat-reactions').on('postgres_changes',{event:'*',schema:'public',table:'reactions'},function(p){
        var id=p.new?p.new.message_id:(p.old?p.old.message_id:null); if(id) refreshReactions(id);
      }).subscribe();
    }
    async function refreshReactions(msgId) {
      var res=await sb.from('reactions').select('*').eq('message_id',msgId); if(res.error) return;
      var wrap=document.querySelector('[data-msg-id="'+msgId+'"]'); if(!wrap) return;
      renderReactionsBar(wrap.querySelector('.reactions-bar'),msgId,res.data);
    }
    /* -------------------------------------------------------
       TYPING ‚Äî via Supabase Broadcast (temps r√©el garanti,
       pas de d√©pendance aux postgres_changes sur UPDATE)
       ------------------------------------------------------- */
    var typingUsers = {};   /* { pseudo: timestamp } */
    var typingChannel = null;

    function subscribeTyping() {
      typingChannel = sb.channel('shade-typing-broadcast', {
        config: { broadcast: { self: false } }
      });

      typingChannel
        .on('broadcast', { event: 'typing' }, function(payload) {
          var p = payload.payload;
          if (!p || !p.pseudo || p.pseudo === myPseudo) return;
          if (p.active) {
            typingUsers[p.pseudo] = Date.now();
          } else {
            delete typingUsers[p.pseudo];
          }
          renderTypingDisplay();
        })
        .subscribe();

      /* Nettoie les pseudos qui n'ont plus envoy√© de signal depuis 4s */
      setInterval(function() {
        var now = Date.now();
        var changed = false;
        Object.keys(typingUsers).forEach(function(p) {
          if (now - typingUsers[p] > 4000) { delete typingUsers[p]; changed = true; }
        });
        if (changed) renderTypingDisplay();
      }, 1000);
    }

    function renderTypingDisplay() {
      var ind = document.getElementById('typingIndicator');
      if (!ind) return;
      var others = Object.keys(typingUsers);
      if (!others.length) { ind.innerHTML = ''; return; }
      var name = others.length === 1 ? others[0] : others.length + ' personnes';
      var verb = others.length === 1 ? ' est en train d\'√©crire' : ' sont en train d\'√©crire';
      ind.innerHTML = '<span style="font-weight:bold;color:rgba(255,255,255,0.6);">' + esc(name) + '</span>' + verb +
        '<span class="typing-dots"><span></span><span></span><span></span></span>';
    }

    function onTyping() {
      if (!myPseudo || !typingChannel) return;
      if (!isTyping) {
        isTyping = true;
        typingChannel.send({ type: 'broadcast', event: 'typing', payload: { pseudo: myPseudo, active: true } });
      }
      clearTimeout(typingTimer);
      typingTimer = setTimeout(stopTyping, 3000);
    }

    function stopTyping() {
      if (!myPseudo || !isTyping) return;
      isTyping = false;
      clearTimeout(typingTimer);
      if (typingChannel) {
        typingChannel.send({ type: 'broadcast', event: 'typing', payload: { pseudo: myPseudo, active: false } });
      }
    }

    function renderReactionsBar(bar,msgId,reactions) {
      if(!bar) return; bar.innerHTML='';
      var counts={},mine={};
      reactions.forEach(function(r){counts[r.emoji]=(counts[r.emoji]||0)+1;if(r.pseudo===myPseudo)mine[r.emoji]=true;});
      Object.keys(counts).forEach(function(e){
        var pill=document.createElement('div'); pill.className='reaction-pill'+(mine[e]?' mine':'');
        pill.innerHTML=EMOJI_MAP[e]+' <span class="count">'+counts[e]+'</span>';
        pill.onclick=function(ev){ev.stopPropagation();toggleReaction(msgId,e);};
        bar.appendChild(pill);
      });
    }
    async function toggleReaction(msgId,emoji) {
      if(!myPseudo) return;
      var check=await sb.from('reactions').select('id').eq('message_id',msgId).eq('pseudo',myPseudo).eq('emoji',emoji);
      if(check.data&&check.data.length) await sb.from('reactions').delete().eq('id',check.data[0].id);
      else await sb.from('reactions').insert([{message_id:msgId,pseudo:myPseudo,emoji:emoji}]);
      refreshReactions(msgId);
    }

    function renderBubble(msg,reactions) {
      var list=document.getElementById('messagesList'),isMe=msg.pseudo===myPseudo,color=getPseudoColor(msg.pseudo);
      var time=new Date(msg.created_at).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
      var wrap=document.createElement('div'); wrap.className='bubble-wrap '+(isMe?'me':'them'); wrap.setAttribute('data-msg-id',msg.id);
      var picker=document.createElement('div'); picker.className='emoji-picker';
      Object.keys(EMOJI_MAP).forEach(function(k){ var btn=document.createElement('button'); btn.className='emoji-pick-btn'; btn.textContent=EMOJI_MAP[k]; btn.onclick=function(e){e.stopPropagation();closePicker();toggleReaction(msg.id,k);}; picker.appendChild(btn); });
      var bubble=document.createElement('div'); bubble.className='bubble';
      bubble.innerHTML=(!isMe?'<div class="bubble-pseudo" style="color:'+color+';">'+esc(msg.pseudo)+'</div>':'')+'<div>'+esc(msg.message)+'</div>'+'<div class="bubble-time">'+time+'</div>';
      bubble.appendChild(picker);
      bubble.addEventListener('click',function(e){ e.stopPropagation(); if(openPicker&&openPicker!==picker) openPicker.classList.remove('show'); picker.classList.toggle('show'); openPicker=picker.classList.contains('show')?picker:null; });
      var bar=document.createElement('div'); bar.className='reactions-bar';
      if(reactions&&reactions.length) renderReactionsBar(bar,msg.id,reactions);
      wrap.appendChild(bubble); wrap.appendChild(bar); list.appendChild(wrap);
    }

    function closePicker(){if(openPicker){openPicker.classList.remove('show');openPicker=null;}}
    document.addEventListener('click',function(){closePicker();});

    async function sendMessage() {
      var input=document.getElementById('msgInput'),message=input.value.trim();
      if(!message||!myPseudo) return;
      input.value=''; stopTyping();
      var res=await sb.from('messages').insert([{pseudo:myPseudo,message:message}]);
      if(res.error) console.error(res.error);
    }
    function scrollBottom(){var l=document.getElementById('messagesList');l.scrollTop=l.scrollHeight;}
    function esc(t){return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}


    /* -------------------------------------------------------
       SERVICE WORKER + WEB PUSH VAPID
       ------------------------------------------------------- */
    var VAPID_PUBLIC_KEY = 'BH2RMI_r3pIOu5WK6n7aTtzF25uWNFxk4AjypiIqn6x2SgtP7_mOyCw4i0a4N3yLe7ypsSd07v8N__-6-6tfirk';
    var swReg = null;

    /* Convertit la cl√© VAPID base64url ‚Üí Uint8Array */
    function urlBase64ToUint8Array(b64) {
      var pad = '='.repeat((4 - b64.length % 4) % 4);
      var raw = atob(b64.replace(/-/g, '+').replace(/_/g, '/') + pad);
      return Uint8Array.from(raw, function(c) { return c.charCodeAt(0); });
    }

    async function registerSW() {
      if (!('serviceWorker' in navigator)) return;
      try {
        swReg = await navigator.serviceWorker.register('/sw.js');
        console.log('[SW] enregistr√©');
      } catch(e) { console.warn('[SW] √©chec :', e); }
    }

    /* Demande la permission puis cr√©e/sauvegarde la subscription push */
    async function setupPushSubscription() {
      if (!swReg || !('PushManager' in window)) return;
      if (!('Notification' in window)) return;

      /* Demande la permission si pas encore accord√©e */
      var perm = Notification.permission;
      if (perm === 'denied') return;
      if (perm !== 'granted') {
        perm = await Notification.requestPermission();
      }
      if (perm !== 'granted') return;

      try {
        /* V√©rifie si une subscription existe d√©j√† */
        var existing = await swReg.pushManager.getSubscription();
        if (existing) {
          await savePushSubscription(existing);
          return;
        }

        /* Cr√©e une nouvelle subscription */
        var sub = await swReg.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
        });
        await savePushSubscription(sub);
        console.log('[Push] subscription cr√©√©e');
      } catch(e) {
        console.warn('[Push] √©chec subscription :', e);
      }
    }

    /* Sauvegarde la subscription dans Supabase */
    async function savePushSubscription(sub) {
      var json = sub.toJSON();
      var endpoint = json.endpoint;
      var p256dh   = json.keys && json.keys.p256dh;
      var auth     = json.keys && json.keys.auth;
      if (!endpoint || !p256dh || !auth) return;

      /* Upsert : √©vite les doublons sur endpoint */
      await sb.from('push_subscriptions').upsert(
        { endpoint: endpoint, p256dh: p256dh, auth: auth },
        { onConflict: 'endpoint' }
      );
    }

    /* INIT */
    registerSW().then(function() {
      /* On tente la subscription d√®s que le SW est pr√™t */
      if (swReg) setupPushSubscription();
    });
    subscribeMessages();

    function onFirstGesture() {
      unlockAudio();
      /* Au premier geste, on (re)tente la subscription si pas encore faite */
      setupPushSubscription();
      try { if ('wakeLock' in navigator) navigator.wakeLock.request('screen').catch(function(){}); } catch(e) {}
    }
    document.addEventListener('touchstart', onFirstGesture, { once: true, passive: true });
    document.addEventListener('click', onFirstGesture, { once: true });
  </script>
</body>
</html>

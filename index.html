<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>SHADE RADIO – Live</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="assets/logo.JPG">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SHADE RADIO">
  <meta name="theme-color" content="#000000">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* ── RESET & BASE ── */
    * { box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    
    /* FIX IOS : Empêche le rebond du body qui fait remonter le lecteur */
    html, body { 
      background: #000; 
      height: 100%; 
      overflow: hidden; 
      position: fixed; 
      width: 100%;
    }

    body::before { content: ""; position: fixed; inset: 0; background: radial-gradient(circle at 50% 40%, rgba(220,0,0,0.55), transparent 65%), radial-gradient(circle at 80% 90%, rgba(150,0,0,0.3), transparent 50%), radial-gradient(circle at 10% 20%, rgba(80,0,0,0.4), transparent 40%); z-index: -1; pointer-events: none; }

    /* ── LAYOUT ── */
    #app { width: 100%; max-width: 420px; display: flex; flex-direction: column; align-items: center; height: 100%; margin: 0 auto; position: relative; }

    /* ── TOP BAR ── */
    .top-bar { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 15px; flex-shrink: 0; }
    .header-container { flex: 1; display: flex; align-items: center; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 12px; overflow: hidden; }
    .live-badge { background: linear-gradient(90deg, #ff0000, #8b0000); color: #fff; font-size: 11px; font-weight: bold; padding: 10px 12px; animation: pulse 1.5s infinite; white-space: nowrap; }
    @keyframes pulse { 0% { box-shadow: inset 0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow: inset 0 0 0 10px rgba(255,255,255,0); } 100% { box-shadow: inset 0 0 0 0 rgba(255,255,255,0); } }
    .radio-ticker { flex: 1; overflow: hidden; padding: 8px 0; display: flex; }
    .radio-ticker span { display: inline-block; white-space: nowrap; padding-left: 100%; animation: scroll-text 12s linear infinite; color: #fff; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    @keyframes scroll-text { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

    /* ── HAMBURGER ── */
    .hamburger-btn { cursor: pointer; background: rgba(180,0,0,0.25); padding: 8px 10px; border-radius: 10px; backdrop-filter: blur(10px); border: 1px solid rgba(255,0,0,0.4); display: flex; flex-direction: column; justify-content: center; transition: 0.3s; box-shadow: 0 0 15px rgba(255,0,0,0.2); flex-shrink: 0; position: relative; }
    .hamburger-btn span { display: block; width: 22px; height: 2px; background: #fff; margin: 3px 0; border-radius: 2px; transition: 0.4s; }
    .hamburger-btn.open span:nth-child(1) { transform: rotate(-45deg) translate(-5px, 6px); }
    .hamburger-btn.open span:nth-child(2) { opacity: 0; }
    .hamburger-btn.open span:nth-child(3) { transform: rotate(45deg) translate(-5px, -6px); }

    /* ── BADGES ── */
    #chatBadge { position: absolute; top: -6px; right: -6px; background: #ff0000; color: #fff; font-size: 10px; font-weight: bold; min-width: 18px; height: 18px; border-radius: 9px; display: none; align-items: center; justify-content: center; padding: 0 4px; border: 2px solid #000; z-index: 10; }
    .chat-menu-badge { background: #ff0000; color: #fff; font-size: 10px; font-weight: bold; min-width: 18px; height: 18px; border-radius: 9px; display: none; align-items: center; justify-content: center; padding: 0 4px; margin-left: 6px; }

    /* ── MAIN FRAME ── */
    .main-frame { background: linear-gradient(180deg, rgba(120,0,0,0.18) 0%, rgba(255,255,255,0.03) 100%); backdrop-filter: blur(20px); border-radius: 50px; padding: 25px 10px 40px 10px; margin-top: 5px; width: 92%; max-width: 340px; position: relative; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 40px 80px rgba(0,0,0,0.9); flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .radio-logo { width: 260px; margin-bottom: 5px; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.8)); animation: logo-swing 7s ease-in-out infinite; }
    @keyframes logo-swing { 0% { opacity: 0; transform: translateZ(400px) rotateY(90deg); } 15% { opacity: 1; transform: translateZ(0) rotateY(0deg); } 35% { transform: rotateY(20deg); } 55% { transform: rotateY(-20deg); } 100% { transform: rotateY(0deg); } }

    /* ── PLAYER ── */
    .player-container { position: relative; width: 100%; display: flex; justify-content: center; margin-top: 15px; }
    #sc-player { background: transparent !important; transform: scale(0.65); transform-origin: top center; height: 300px; position: relative; z-index: 2; }
    .custom-vinyl { position: absolute; top: 191px; width: 155px; height: 155px; z-index: 1; animation: vinyl-spin 6s linear infinite; }
    @keyframes vinyl-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* ── BANDEAU PUB ── */
    .ad-banner { position: absolute; bottom: 25px; width: 85%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 10px; overflow: hidden; display: flex; }
    .ad-ticker { flex: 1; padding: 7px 0; overflow: hidden; display: flex; }
    .ad-ticker span { display: inline-block; white-space: nowrap; padding-left: 100%; animation: scroll-text 14s linear infinite; color: #fff; font-size: 10px; font-weight: 500; text-transform: uppercase; }

    /* ── OVERLAYS ── */
    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      height: 100dvh;
      backdrop-filter: blur(25px) saturate(150%);
      -webkit-backdrop-filter: blur(25px) saturate(150%);
      background: rgba(0,0,0,0.35);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      pointer-events: none; visibility: hidden; overflow: hidden; z-index: 200;
    }
    .overlay.open { pointer-events: all; visibility: visible; }

    /* ── CHAT SPECIFIQUE ── */
    #chatOverlay { transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.77,0.2,0.05,1.0); justify-content: flex-start; }
    #chatOverlay.open { transform: translateY(0); }
    .chat-header { width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.12); flex-shrink: 0; }
    .chat-body { flex: 1; display: none; flex-direction: column; width: 100%; overflow: hidden; }
    .chat-body.show { display: flex; }
    .messages-list { flex: 1; overflow-y: auto; padding: 14px; display: flex; flex-direction: column; gap: 10px; -webkit-overflow-scrolling: touch; }

    /* FIX IPHONE : Barre de saisie */
    .chat-input-row {
      display: flex; align-items: center; gap: 10px; padding: 10px 14px;
      padding-bottom: max(10px, env(safe-area-inset-bottom));
      border-top: 1px solid rgba(255,255,255,0.1);
      background: rgba(0,0,0,0.8);
      width: 100%;
      flex-shrink: 0;
      /* On ne met pas de position fixed ici, le JS s'en chargera dynamiquement sur iPhone */
    }
    .chat-input { flex: 1; padding: 11px 16px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.08); color: #fff; font-size: 16px; outline: none; }
    .send-btn { background: linear-gradient(135deg, #ff0000, #8b0000); border: none; width: 42px; height: 42px; border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; }

    /* ... (Autres styles menu/historique de ton code original ici) ... */
    .menu-link { color: #fff; text-decoration: none; font-size: 17px; font-weight: bold; text-transform: uppercase; padding: 15px 25px; border-radius: 50px; background: rgba(255,255,255,0.08); width: 80%; text-align: center; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; }
  </style>
</head>
<body>

  <div id="app">
    <div class="top-bar">
      <div class="header-container">
        <div class="live-badge">● LIVE</div>
        <div class="radio-ticker"><span>100% Hip-Hop Classic – Shade Radio – Retrouvez-nous tous les soirs dès 21h sur TikTok</span></div>
      </div>
      <div class="hamburger-btn" id="hamburgerBtn" onclick="toggleMenu()">
        <span></span><span></span><span></span>
        <div id="chatBadge"></div>
      </div>
    </div>

    <div class="main-frame">
      <img src="assets/logo2.PNG" alt="SHADE RADIO" class="radio-logo">
      <div class="player-container">
        <img src="assets/disque.PNG" class="custom-vinyl" alt="Vinyl">
        <div id="sc-player" is="player" lang="fr"
          api-url="https://manager11.streamradio.fr:1700/api/v2"
          server-id="1" station-name="SHADE RADIO"
          imagecontainer="top" controlscontainer="bottom"
          :show-history="false" :show-share="false" :show-dj="false"
          :show-image="true" :show-bitrate="false"
          play-button-color="#ffffff" :progress-show="false" player-width="100%">
        </div>
      </div>
      <div class="ad-banner">
        <div class="ad-ticker"><span>Pour diffuser votre publicité, contactez nous via l'onglet demande de pub dans le menu.</span></div>
      </div>
    </div>
  </div>

  <div class="overlay" id="menuOverlay" style="gap:15px; flex-direction: column;">
    <a href="javascript:void(0)" class="menu-link" onclick="closeMenu(); setTimeout(openChat, 450);">
      <i class="fas fa-comments"></i> Chat Auditeurs <span class="chat-menu-badge" id="chatMenuBadge"></span>
    </a>
    <button onclick="toggleMenu()" style="color:white; background:none; border:none; margin-top:20px;">Fermer</button>
  </div>

  <div class="overlay" id="chatOverlay">
    <div class="chat-header">
      <div style="color:white; font-weight:bold;">Chat Auditeurs</div>
      <button onclick="closeChat()" style="color:white; background:none; border:none; font-size:20px;">✕</button>
    </div>

    <div class="pseudo-screen" id="pseudoScreen" style="display:flex; flex-direction:column; align-items:center; justify-content:center; flex:1; gap:20px;">
      <h2 style="color:white;">Ton Pseudo</h2>
      <input class="pseudo-input" id="pseudoInput" type="text" placeholder="Ton pseudo..." style="padding:10px; border-radius:20px; border:none;">
      <button class="btn-join" onclick="joinChat()" style="padding:10px 30px; border-radius:20px; background:red; color:white; border:none; font-weight:bold;">Rejoindre</button>
    </div>

    <div class="chat-body" id="chatBody">
      <div class="messages-list" id="messagesList"></div>
      <div class="chat-input-row" id="chatInputRow">
        <input class="chat-input" id="msgInput" type="text" placeholder="Ton message..." maxlength="200" autocomplete="off">
        <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <script src="https://manager11.streamradio.fr:1700/media/static/js/sc_player/sc_player.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // Config Supabase (Tes identifiants)
    var SUPA_URL = 'https://rxhyapahjaypeudletdy.supabase.co';
    var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4aHlhcGFoamF5cGV1ZGxldGR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ5MjYsImV4cCI6MjA4NzYxMDkyNn0.tkvyJVBP1PW5UKh8Kewwft0L-iTZzddx6QXBiNbvB_0';
    var sb = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    var myPseudo = localStorage.getItem('shade_pseudo') || null;

    function toggleMenu() { document.getElementById('menuOverlay').classList.toggle('open'); }
    function closeMenu() { document.getElementById('menuOverlay').classList.remove('open'); }
    function openChat() { 
        document.getElementById('chatOverlay').classList.add('open'); 
        if(myPseudo) showMessages();
    }
    function closeChat() { document.getElementById('chatOverlay').classList.remove('open'); }

    function joinChat() {
      var p = document.getElementById('pseudoInput').value.trim();
      if(!p) return;
      myPseudo = p; localStorage.setItem('shade_pseudo', p);
      showMessages();
    }

    function showMessages() {
      document.getElementById('pseudoScreen').style.display = 'none';
      document.getElementById('chatBody').classList.add('show');
      // Activation du fix clavier ici
      initIOSKeyboardFix();
    }

    async function sendMessage() {
      var inp = document.getElementById('msgInput');
      var m = inp.value.trim();
      if(!m) return;
      inp.value = '';
      await sb.from('messages').insert([{ pseudo: myPseudo, message: m }]);
      // Simu locale
      renderMsg(myPseudo, m);
    }

    function renderMsg(p, m) {
      var list = document.getElementById('messagesList');
      var d = document.createElement('div');
      d.style.color = "white"; d.style.padding = "5px";
      d.innerHTML = `<b>${p}:</b> ${m}`;
      list.appendChild(d);
      list.scrollTop = list.scrollHeight;
    }

    /* ============================================================
       FIX CHIRURGICAL CLAVIER IPHONE
    ============================================================ */
    function initIOSKeyboardFix() {
      if (!window.visualViewport) return;

      const inputRow = document.getElementById('chatInputRow');
      const chatOverlay = document.getElementById('chatOverlay');

      window.visualViewport.addEventListener('resize', () => {
        if (chatOverlay.classList.contains('open')) {
          const keyboardHeight = window.innerHeight - window.visualViewport.height;
          
          if (keyboardHeight > 50) {
            // Le clavier est là : on fixe la barre au-dessus
            inputRow.style.position = 'fixed';
            inputRow.style.bottom = keyboardHeight + 'px';
            inputRow.style.left = '0';
            inputRow.style.zIndex = '3000';
          } else {
            // Le clavier est parti : retour au flux normal
            inputRow.style.position = 'relative';
            inputRow.style.bottom = '0';
          }
        }
      });
    }

    // Empêche le décalage de page d'iOS
    document.addEventListener('focusin', (e) => {
      if (e.target.tagName === 'INPUT') {
        window.scrollTo(0, 0);
        document.body.scrollTop = 0;
      }
    });

  </script>
</body>
</html>

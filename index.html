<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>SHADE RADIO – Live</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="assets/logo.JPG">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SHADE RADIO">
  <meta name="theme-color" content="#000000">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { background: #000; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; overflow: hidden; padding-top: env(safe-area-inset-top, 10px); position: relative; perspective: 1200px; }
    body::before { content: ""; position: fixed; inset: 0; background: radial-gradient(circle at 50% 40%, rgba(220,0,0,0.55), transparent 65%), radial-gradient(circle at 80% 90%, rgba(150,0,0,0.3), transparent 50%), radial-gradient(circle at 10% 20%, rgba(80,0,0,0.4), transparent 40%); z-index: -1; pointer-events: none; }
    #app { width: 100%; max-width: 420px; display: flex; flex-direction: column; align-items: center; }
    .top-bar { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 15px; }
    .header-container { flex: 1; display: flex; align-items: center; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 12px; overflow: hidden; }
    .live-badge { background: linear-gradient(90deg, #ff0000, #8b0000); color: #fff; font-size: 11px; font-weight: bold; padding: 10px 12px; animation: pulse 1.5s infinite; white-space: nowrap; }
    @keyframes pulse { 0% { box-shadow: inset 0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow: inset 0 0 0 10px rgba(255,255,255,0); } 100% { box-shadow: inset 0 0 0 0 rgba(255,255,255,0); } }
    .radio-ticker { flex: 1; overflow: hidden; padding: 8px 0; display: flex; }
    .radio-ticker span { display: inline-block; white-space: nowrap; padding-left: 100%; animation: scroll-text 12s linear infinite; color: #fff; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    @keyframes scroll-text { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    .hamburger-btn { cursor: pointer; background: rgba(180,0,0,0.25); padding: 8px 10px; border-radius: 10px; backdrop-filter: blur(10px); border: 1px solid rgba(255,0,0,0.4); display: flex; flex-direction: column; justify-content: center; transition: 0.3s; box-shadow: 0 0 15px rgba(255,0,0,0.2); flex-shrink: 0; position: relative; }
    .hamburger-btn span { display: block; width: 22px; height: 2px; background: #fff; margin: 3px 0; border-radius: 2px; transition: 0.4s; }
    .hamburger-btn.open span:nth-child(1) { transform: rotate(-45deg) translate(-5px, 6px); }
    .hamburger-btn.open span:nth-child(2) { opacity: 0; }
    .hamburger-btn.open span:nth-child(3) { transform: rotate(45deg) translate(-5px, -6px); }
    #chatBadge { position: absolute; top: -6px; right: -6px; background: #ff0000; color: #fff; font-size: 10px; font-weight: bold; min-width: 18px; height: 18px; border-radius: 9px; display: none; align-items: center; justify-content: center; padding: 0 4px; border: 2px solid #000; z-index: 10; }
    @keyframes badge-pop { from { transform: scale(0); } to { transform: scale(1); } }
    .chat-menu-badge { background: #ff0000; color: #fff; font-size: 10px; font-weight: bold; min-width: 18px; height: 18px; border-radius: 9px; display: none; align-items: center; justify-content: center; padding: 0 4px; margin-left: 6px; }
    .main-frame { background: linear-gradient(180deg, rgba(120,0,0,0.18) 0%, rgba(255,255,255,0.03) 100%); backdrop-filter: blur(20px); border-radius: 50px; padding: 25px 10px 220px 10px; margin-top: 5px; width: 92%; max-width: 340px; position: relative; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 40px 80px rgba(0,0,0,0.9), inset 0 0 20px rgba(255,0,0,0.1); }
    .radio-logo { width: 290px; margin: 0 auto 5px; display: block; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.8)) drop-shadow(0 0 20px rgba(255,0,0,0.3)); animation: logo-swing 7s ease-in-out infinite; }
    @keyframes logo-swing { 0% { opacity: 0; transform: translateZ(400px) rotateY(90deg); filter: brightness(0) blur(10px); } 15% { opacity: 1; transform: translateZ(0) rotateY(0deg); filter: brightness(1); } 35% { transform: rotateY(20deg); filter: brightness(1.2); } 55% { transform: rotateY(-20deg); filter: brightness(1.2); } 75% { transform: rotateY(20deg); } 100% { transform: rotateY(0deg); filter: brightness(1); } }
    .player-container { position: relative; width: 100%; display: flex; justify-content: center; margin-top: 15px; }
    .player-container::after { content: ""; position: absolute; top: -8px; width: 221px; height: 221px; border-radius: 32px; background: linear-gradient(110deg, rgba(255,255,255,0) 40%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 60%); background-size: 200% 100%; pointer-events: none; z-index: 10; animation: gloss 4s linear infinite; }
    @keyframes gloss { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    #sc-player { background: transparent !important; transform: scale(0.65); transform-origin: top center; height: 300px; position: relative; z-index: 2; }
    #sc-player, #sc-player * { background: transparent !important; box-shadow: none !important; border: none !important; }
    #sc-player img { width: 100% !important; border-radius: 40px !important; box-shadow: 0 15px 35px rgba(0,0,0,0.8) !important; }
    #sc-player [class*="play-button"] { background: #001f3f !important; border-radius: 50% !important; border: 2px solid rgba(255,255,255,0.8) !important; box-shadow: 0 0 20px rgba(0,31,63,0.6), 0 0 10px rgba(255,255,255,0.2) !important; z-index: 5; transition: transform 0.2s; }
    #sc-player [class*="play-button"]:active { transform: scale(0.9); }
    .custom-vinyl { position: absolute; top: 191px; width: 155px; height: 155px; z-index: 1; animation: vinyl-spin 6s linear infinite; filter: drop-shadow(0 0 15px rgba(0,0,0,0.6)); }
    @keyframes vinyl-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .ad-banner { position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); width: 85%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 10px; overflow: hidden; display: flex; }
    .ad-ticker { flex: 1; padding: 7px 0; overflow: hidden; display: flex; }
    .ad-ticker span { display: inline-block; white-space: nowrap; padding-left: 100%; animation: scroll-text 14s linear infinite; color: #fff; font-size: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; backdrop-filter: blur(25px) saturate(150%); -webkit-backdrop-filter: blur(25px) saturate(150%); background: rgba(0,0,0,0.35); display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; visibility: hidden; }
    .overlay.open { pointer-events: all; visibility: visible; }
    #menuOverlay { z-index: 200; gap: 15px; right: -100%; left: auto; width: 100%; transition: right 0.45s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0.45s; }
    #menuOverlay.open { right: 0; transition: right 0.45s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0s; }
    .menu-logo { width: 130px; margin-bottom: 20px; filter: drop-shadow(0 0 10px rgba(255,255,255,0.2)); opacity: 0; transform: scale(0.8); transition: opacity 0.5s 0.3s, transform 0.5s 0.3s cubic-bezier(0.175,0.885,0.32,1.275); }
    #menuOverlay.open .menu-logo { opacity: 1; transform: scale(1); }
    .menu-link { color: #fff; text-decoration: none; font-size: 17px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; padding: 15px 25px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); width: 80%; max-width: 300px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: background 0.2s, transform 0.2s; cursor: pointer; -webkit-user-select: none; user-select: none; }
    .menu-link:active { background: rgba(255,255,255,0.2); transform: scale(0.96); }
    #chatOverlay { z-index: 300; justify-content: flex-start; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0.4s; padding-top: env(safe-area-inset-top, 10px); }
    #chatOverlay.open { transform: translateY(0); transition: transform 0.4s cubic-bezier(0.77,0.2,0.05,1.0), visibility 0s 0s; }
    .chat-header { width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 15px 20px; border-bottom: 1px solid rgba(255,255,255,0.12); flex-shrink: 0; }
    .chat-header-left { display: flex; align-items: center; gap: 12px; }
    .chat-avatar { width: 40px; height: 40px; background: linear-gradient(135deg, #ff0000, #8b0000); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; }
    .chat-title { color: #fff; font-weight: bold; font-size: 15px; }
    .chat-sub { color: rgba(255,255,255,0.45); font-size: 11px; margin-top: 2px; }
    .close-btn { background: rgba(255,255,255,0.1); border: none; color: #fff; width: 34px; height: 34px; border-radius: 50%; font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .pseudo-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px 20px; gap: 20px; width: 100%; }
    .pseudo-screen h2 { color: #fff; font-size: 22px; text-align: center; }
    .pseudo-screen p { color: rgba(255,255,255,0.55); font-size: 14px; text-align: center; }
    .pseudo-input { width: 100%; max-width: 300px; padding: 14px 20px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.2); background: rgba(255,255,255,0.08); color: #fff; font-size: 16px; outline: none; text-align: center; }
    .pseudo-input::placeholder { color: rgba(255,255,255,0.35); }
    .btn-join { background: linear-gradient(90deg, #ff0000, #8b0000); color: #fff; border: none; padding: 14px 44px; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; letter-spacing: 1px; box-shadow: 0 4px 20px rgba(255,0,0,0.4); transition: transform 0.2s; }
    .btn-join:active { transform: scale(0.95); }
    .chat-body { flex: 1; display: none; flex-direction: column; overflow: hidden; width: 100%; }
    .chat-body.show { display: flex; }
    .messages-list { flex: 1; overflow-y: auto; padding: 14px 14px 8px; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; }
    .messages-list::-webkit-scrollbar { display: none; }
    .expired-notice { text-align: center; color: rgba(255,255,255,0.3); font-size: 11px; padding: 6px 0; font-style: italic; }
    .bubble { max-width: 76%; padding: 9px 14px; border-radius: 18px; font-size: 14px; line-height: 1.45; word-break: break-word; animation: pop-in 0.22s ease; }
    @keyframes pop-in { from { opacity: 0; transform: scale(0.85) translateY(8px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    .bubble.them { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.1); color: #fff; align-self: flex-start; border-bottom-left-radius: 4px; }
    .bubble.me { background: linear-gradient(135deg, #ff0000, #8b0000); color: #fff; align-self: flex-end; border-bottom-right-radius: 4px; }
    .bubble-pseudo { font-size: 11px; font-weight: bold; color: rgba(255,255,255,0.5); margin-bottom: 3px; }
    .bubble-time { font-size: 10px; color: rgba(255,255,255,0.3); margin-top: 3px; text-align: right; }
    .chat-input-row { display: flex; align-items: center; gap: 10px; padding: 10px 14px; padding-bottom: max(10px, env(safe-area-inset-bottom)); border-top: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; }
    .chat-input { flex: 1; padding: 11px 16px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.15); background: rgba(255,255,255,0.08); color: #fff; font-size: 15px; outline: none; }
    .chat-input::placeholder { color: rgba(255,255,255,0.35); }
    .send-btn { background: linear-gradient(135deg, #ff0000, #8b0000); border: none; width: 42px; height: 42px; border-radius: 50%; color: #fff; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 10px rgba(255,0,0,0.4); transition: transform 0.2s; flex-shrink: 0; }
    .send-btn:active { transform: scale(0.9); }
  </style>
</head>
<body>

  <!-- MENU OVERLAY -->
  <div class="overlay" id="menuOverlay">
    <img src="assets/logo2.PNG" alt="SHADE RADIO" class="menu-logo">
    <a href="mailto:shaderadiolive@gmail.com?subject=Demande de titre&body=Artiste : %0D%0ATitre : " class="menu-link" onclick="closeMenu()">
      <i class="fas fa-music"></i> Demander un titre
    </a>
    <a href="mailto:shaderadiolive@gmail.com?subject=Demande de pub" class="menu-link" onclick="closeMenu()">
      <i class="fas fa-ad"></i> Demande de pub
    </a>
    <a href="javascript:void(0)" class="menu-link" onclick="shareRadio(); closeMenu();">
      <i class="fas fa-share-nodes"></i> Partager la radio
    </a>
    <a href="https://www.tiktok.com/@shaderadio" target="_blank" class="menu-link" onclick="closeMenu()">
      <i class="fab fa-tiktok"></i> Rejoins-nous sur TikTok
    </a>
    <a href="javascript:void(0)" class="menu-link" id="chatMenuLink" onclick="closeMenu(); setTimeout(openChat, 450);">
      <i class="fas fa-comments"></i> Chat Auditeurs
      <span class="chat-menu-badge" id="chatMenuBadge"></span>
    </a>
  </div>

  <!-- CHAT OVERLAY -->
  <div class="overlay" id="chatOverlay">
    <div class="chat-header">
      <div class="chat-header-left">
        <div class="chat-avatar">&#127897;</div>
        <div>
          <div class="chat-title">Chat Auditeurs</div>
          <div class="chat-sub">Shade Radio - Live</div>
        </div>
      </div>
      <button class="close-btn" onclick="closeChat()">X</button>
    </div>
    <div class="pseudo-screen" id="pseudoScreen">
      <div style="font-size:50px">&#127911;</div>
      <h2>Rejoins le chat !</h2>
      <p>Choisis un pseudo pour discuter avec les autres auditeurs.</p>
      <input class="pseudo-input" id="pseudoInput" type="text" placeholder="Ton pseudo..." maxlength="20" autocomplete="off" onkeydown="if(event.key==='Enter') joinChat()">
      <button class="btn-join" onclick="joinChat()">Rejoindre</button>
    </div>
    <div class="chat-body" id="chatBody">
      <div class="messages-list" id="messagesList"></div>
      <div class="chat-input-row">
        <input class="chat-input" id="msgInput" type="text" placeholder="Ton message..." maxlength="200" autocomplete="off" onkeydown="if(event.key==='Enter') sendMessage()">
        <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div id="app">
    <div class="top-bar">
      <div class="header-container">
        <div class="live-badge">&#9679; LIVE</div>
        <div class="radio-ticker">
          <span>100% Hip-Hop Classic - Shade Radio - Retrouvez-nous tous les soirs des 21h sur TikTok</span>
        </div>
      </div>
      <div class="hamburger-btn" id="hamburgerBtn" onclick="toggleMenu()">
        <span></span><span></span><span></span>
        <div id="chatBadge"></div>
      </div>
    </div>
    <div class="main-frame">
      <img src="assets/logo2.PNG" alt="SHADE RADIO" class="radio-logo">
      <div class="player-container">
        <img src="assets/disque.PNG" class="custom-vinyl" alt="Vinyl">
        <div id="sc-player" is="player" lang="fr"
          api-url="https://manager11.streamradio.fr:1700/api/v2"
          server-id="1" station-name="SHADE RADIO"
          imagecontainer="top" controlscontainer="bottom"
          :show-history="false" :show-share="false" :show-dj="false"
          :show-image="true" :show-bitrate="false"
          play-button-color="#ffffff" :progress-show="false" player-width="100%">
        </div>
      </div>
      <div class="ad-banner">
        <div class="ad-ticker">
          <span>Pour diffuser votre publicite, contactez nous via l'onglet demande de pub dans le menu.</span>
        </div>
      </div>
    </div>
  </div>

  <script src="https://manager11.streamradio.fr:1700/media/static/js/sc_player/sc_player.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    var SUPA_URL = 'https://rxhyapahjaypeudletdy.supabase.co';
    var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4aHlhcGFoamF5cGV1ZGxldGR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ5MjYsImV4cCI6MjA4NzYxMDkyNn0.tkvyJVBP1PW5UKh8Kewwft0L-iTZzddx6QXBiNbvB_0';
    var sb = window.supabase.createClient(SUPA_URL, SUPA_KEY);

    var myPseudo    = localStorage.getItem('shade_pseudo') || null;
    var chatSub     = null;
    var unreadCount = 0;
    var EXPIRY_MS   = 24 * 60 * 60 * 1000;

    /* =====================
       AUDIO — Web Audio API
       Fonctionne sur iOS Safari, Android Chrome, desktop.
       Le contexte est cree et debloque au premier geste.
    ===================== */
    var audioCtx     = null;
    var audioUnlocked = false;

    function getAudioCtx() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      return audioCtx;
    }

    /* Joue un buffer silencieux pour debloquer l'audio sur iOS */
    function unlockAudio() {
      if (audioUnlocked) return;
      try {
        var ctx = getAudioCtx();
        var buf    = ctx.createBuffer(1, 1, 22050);
        var source = ctx.createBufferSource();
        source.buffer = buf;
        source.connect(ctx.destination);
        source.start(0);
        source.disconnect();
        ctx.resume().then(function() {
          audioUnlocked = true;
        }).catch(function(){});
      } catch(e) {}
    }

    function playNotifSound() {
      try {
        var ctx = getAudioCtx();

        function doPlay() {
          var freqs = [880, 1100];
          for (var i = 0; i < freqs.length; i++) {
            (function(freq, idx) {
              var osc  = ctx.createOscillator();
              var gain = ctx.createGain();
              osc.connect(gain);
              gain.connect(ctx.destination);
              osc.type = 'sine';
              var t = ctx.currentTime + idx * 0.15;
              osc.frequency.setValueAtTime(freq, t);
              gain.gain.setValueAtTime(0.0001, t);
              gain.gain.linearRampToValueAtTime(0.4, t + 0.02);
              gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.4);
              osc.start(t);
              osc.stop(t + 0.41);
            })(freqs[i], i);
          }
        }

        if (ctx.state === 'suspended') {
          ctx.resume().then(doPlay).catch(function(e) {
            console.warn('Audio resume failed:', e);
          });
        } else {
          doPlay();
        }
      } catch(e) {
        console.warn('Audio error:', e);
      }
    }

    /* =====================
       BADGE
    ===================== */
    function showBadge(n) {
      var badge     = document.getElementById('chatBadge');
      var menuBadge = document.getElementById('chatMenuBadge');
      if (n > 0) {
        var label = n > 99 ? '99+' : String(n);
        badge.textContent     = label;
        menuBadge.textContent = label;
        badge.style.display     = 'flex';
        menuBadge.style.display = 'flex';
        badge.style.animation = 'none';
        badge.offsetHeight;
        badge.style.animation = 'badge-pop 0.3s cubic-bezier(0.175,0.885,0.32,1.275)';
      } else {
        badge.style.display     = 'none';
        menuBadge.style.display = 'none';
      }
    }

    function resetBadge() {
      unreadCount = 0;
      showBadge(0);
    }

    /* =====================
       MENU
    ===================== */
    function toggleMenu() {
      var menu   = document.getElementById('menuOverlay');
      var btn    = document.getElementById('hamburgerBtn');
      var isOpen = menu.classList.contains('open');
      if (isOpen) {
        menu.classList.remove('open');
        btn.classList.remove('open');
      } else {
        menu.classList.add('open');
        btn.classList.add('open');
      }
    }

    function closeMenu() {
      document.getElementById('menuOverlay').classList.remove('open');
      document.getElementById('hamburgerBtn').classList.remove('open');
    }

    function shareRadio() {
      if (navigator.share) {
        navigator.share({ title: 'SHADE RADIO', text: 'Ecoute SHADE RADIO !', url: window.location.href });
      }
    }

    /* =====================
       CHAT
    ===================== */
    function openChat() {
      document.getElementById('chatOverlay').classList.add('open');
      resetBadge();
      if (myPseudo) {
        showMessages();
      } else {
        document.getElementById('pseudoScreen').style.display = 'flex';
        document.getElementById('chatBody').classList.remove('show');
      }
    }

    function closeChat() {
      document.getElementById('chatOverlay').classList.remove('open');
    }

    function joinChat() {
      var input  = document.getElementById('pseudoInput');
      var pseudo = input.value.trim();
      if (!pseudo) { input.focus(); return; }
      myPseudo = pseudo;
      localStorage.setItem('shade_pseudo', pseudo);
      showMessages();
    }

    function showMessages() {
      document.getElementById('pseudoScreen').style.display = 'none';
      document.getElementById('chatBody').classList.add('show');
      loadMessages();
      if (!chatSub) subscribeMessages();
    }

    function isRecent(dateStr) {
      return (Date.now() - new Date(dateStr).getTime()) < EXPIRY_MS;
    }

    async function loadMessages() {
      var since = new Date(Date.now() - EXPIRY_MS).toISOString();
      var res = await sb.from('messages').select('*').gte('created_at', since).order('created_at', { ascending: true }).limit(200);
      if (res.error) { console.error(res.error); return; }
      var list = document.getElementById('messagesList');
      list.innerHTML = '';
      if (res.data.length === 0) {
        var notice = document.createElement('div');
        notice.className   = 'expired-notice';
        notice.textContent = 'Aucun message recent. Soyez le premier a ecrire !';
        list.appendChild(notice);
      } else {
        res.data.forEach(renderBubble);
      }
      scrollBottom();
    }

    function subscribeMessages() {
      chatSub = sb.channel('chat')
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, function(payload) {
          var msg = payload.new;
          if (!isRecent(msg.created_at)) return;
          var chatOpen = document.getElementById('chatOverlay').classList.contains('open');
          if (chatOpen) {
            renderBubble(msg);
            scrollBottom();
          } else {
            if (msg.pseudo !== myPseudo) {
              unreadCount++;
              showBadge(unreadCount);
              playNotifSound();
            }
          }
        })
        .subscribe();
    }

    function renderBubble(msg) {
      var list = document.getElementById('messagesList');
      var isMe = msg.pseudo === myPseudo;
      var div  = document.createElement('div');
      div.className = 'bubble ' + (isMe ? 'me' : 'them');
      var time = new Date(msg.created_at).toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
      div.innerHTML =
        (!isMe ? '<div class="bubble-pseudo">' + esc(msg.pseudo) + '</div>' : '') +
        '<div>' + esc(msg.message) + '</div>' +
        '<div class="bubble-time">' + time + '</div>';
      list.appendChild(div);
    }

    async function sendMessage() {
      var input   = document.getElementById('msgInput');
      var message = input.value.trim();
      if (!message || !myPseudo) return;
      input.value = '';
      var res = await sb.from('messages').insert([{ pseudo: myPseudo, message: message }]);
      if (res.error) console.error(res.error);
    }

    function scrollBottom() {
      var list = document.getElementById('messagesList');
      list.scrollTop = list.scrollHeight;
    }

    function esc(t) {
      return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    /* =====================
       INIT
    ===================== */
    subscribeMessages();

    /* Deverrouillage audio + wake lock au premier geste */
    function onFirstGesture() {
      unlockAudio();
      try {
        if ('wakeLock' in navigator) {
          navigator.wakeLock.request('screen').catch(function(){});
        }
      } catch(e) {}
    }

    document.addEventListener('touchstart', onFirstGesture, { once: true, passive: true });
    document.addEventListener('click',      onFirstGesture, { once: true });

  </script>
</body>
</html>

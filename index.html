<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>SHADE RADIO – Live</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="assets/logo.JPG">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SHADE RADIO">
  <meta name="theme-color" content="#000000">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; font-family: Arial, Helvetica, sans-serif; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { background: #000; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; overflow: hidden; padding-top: env(safe-area-inset-top, 10px); position: relative; perspective: 1200px; }
    body::before { content: ""; position: fixed; inset: 0; background: radial-gradient(circle at 50% 40%, rgba(220,0,0,0.55), transparent 65%), radial-gradient(circle at 80% 90%, rgba(150,0,0,0.3), transparent 50%), radial-gradient(circle at 10% 20%, rgba(80,0,0,0.4), transparent 40%); z-index: -1; pointer-events: none; }
    #app { width: 100%; max-width: 420px; display: flex; flex-direction: column; align-items: center; }
    .top-bar { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 15px; }
    .header-container { flex: 1; display: flex; align-items: center; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 12px; overflow: hidden; }
    .live-badge { background: linear-gradient(90deg, #ff0000, #8b0000); color: #fff; font-size: 11px; font-weight: bold; padding: 10px 12px; animation: pulse 1.5s infinite; white-space: nowrap; }
    @keyframes pulse { 0% { box-shadow: inset 0 0 0 0 rgba(255,255,255,0.4); } 70% { box-shadow: inset 0 0 0 10px rgba(255,255,255,0); } 100% { box-shadow: inset 0 0 0 0 rgba(255,255,255,0); } }
    .radio-ticker { flex: 1; overflow: hidden; padding: 8px 0; display: flex; }
    .radio-ticker span { display: inline-block; white-space: nowrap; padding-left: 100%; animation: scroll-text 12s linear infinite; color: #fff; font-size: 11px; font-weight: 600; text-transform: uppercase; }
    @keyframes scroll-text { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    .hamburger-btn { cursor: pointer; background: rgba(180,0,0,0.25); padding: 8px 10px; border-radius: 10px; backdrop-filter: blur(10px); border: 1px solid rgba(255,0,0,0.4); display: flex; flex-direction: column; justify-content: center; transition: 0.3s; box-shadow: 0 0 15px rgba(255,0,0,0.2); flex-shrink: 0; position: relative; }
    .hamburger-btn span { display: block; width: 22px; height: 2px; background: #fff; margin: 3px 0; border-radius: 2px; transition: 0.4s; }
    .hamburger-btn.open span:nth-child(1) { transform: rotate(-45deg) translate(-5px, 6px); }
    .hamburger-btn.open span:nth-child(2) { opacity: 0; }
    .hamburger-btn.open span:nth-child(3) { transform: rotate(45deg) translate(-5px, -6px); }
    #chatBadge { position: absolute; top: -6px; right: -6px; background: #ff0000; color: #fff; font-size: 10px; font-weight: bold; min-width: 18px; height: 18px; border-radius: 9px; display: none; align-items: center; justify-content: center; padding: 0 4px; border: 2px solid #000; z-index: 10; }
    .main-frame { background: linear-gradient(180deg, rgba(120,0,0,0.18) 0%, rgba(255,255,255,0.03) 100%); backdrop-filter: blur(20px); border-radius: 50px; padding: 25px 10px 220px 10px; margin-top: 5px; width: 92%; max-width: 340px; position: relative; border: 2px solid rgba(255,255,255,0.2); box-shadow: 0 40px 80px rgba(0,0,0,0.9), inset 0 0 20px rgba(255,0,0,0.1); }
    .radio-logo { width: 290px; margin: 0 auto 5px; display: block; filter: drop-shadow(0 10px 15px rgba(0,0,0,0.8)) drop-shadow(0 0 20px rgba(255,0,0,0.3)); animation: logo-swing 7s ease-in-out infinite; }
    @keyframes logo-swing { 0% { opacity: 0; transform: translateZ(400px) rotateY(90deg); filter: brightness(0) blur(10px); } 15% { opacity: 1; transform: translateZ(0) rotateY(0deg); filter: brightness(1); } 35% { transform: rotateY(20deg); filter: brightness(1.2); } 55% { transform: rotateY(-20deg); filter: brightness(1.2); } 75% { transform: rotateY(20deg); } 100% { transform: rotateY(0deg); filter: brightness(1); } }
    .player-container { position: relative; width: 100%; display: flex; justify-content: center; margin-top: 15px; }
    #sc-player { background: transparent !important; transform: scale(0.65); transform-origin: top center; height: 300px; position: relative; z-index: 2; }
    .custom-vinyl { position: absolute; top: 191px; width: 155px; height: 155px; z-index: 1; animation: vinyl-spin 6s linear infinite; filter: drop-shadow(0 0 15px rgba(0,0,0,0.6)); }
    @keyframes vinyl-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; backdrop-filter: blur(25px); background: rgba(0,0,0,0.35); display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; visibility: hidden; }
    .overlay.open { pointer-events: all; visibility: visible; }
    #chatOverlay { z-index: 300; justify-content: flex-start; transform: translateY(100%); transition: transform 0.4s; padding-top: env(safe-area-inset-top, 10px); }
    #chatOverlay.open { transform: translateY(0); }
    .pseudo-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px 20px; gap: 20px; width: 100%; }
    .pseudo-input { width: 100%; max-width: 300px; padding: 14px 20px; border-radius: 50px; background: rgba(255,255,255,0.08); color: #fff; text-align: center; border: 1px solid rgba(255,255,255,0.2); }
    .btn-join { background: linear-gradient(90deg, #ff0000, #8b0000); color: #fff; border: none; padding: 14px 44px; border-radius: 50px; font-weight: bold; cursor: pointer; }
    .chat-body { flex: 1; display: none; flex-direction: column; width: 100%; }
    .chat-body.show { display: flex; }
    .messages-list { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
    .chat-input-row { display: flex; gap: 10px; padding: 15px; border-top: 1px solid rgba(255,255,255,0.1); }
    .chat-input { flex: 1; padding: 12px; border-radius: 20px; background: rgba(255,255,255,0.1); color: #fff; border: none; }
    .send-btn { background: #ff0000; border: none; width: 45px; height: 45px; border-radius: 50%; color: #fff; cursor: pointer; }
  </style>
</head>
<body>

  <div class="overlay" id="menuOverlay">
    <img src="assets/logo2.PNG" alt="SHADE RADIO" style="width:130px; margin-bottom:20px;">
    <button class="btn-join" onclick="toggleMenu(); setTimeout(openChat, 400)">Chat Auditeurs</button>
  </div>

  <div class="overlay" id="chatOverlay">
    <div style="width:100%; display:flex; justify-content:flex-end; padding:20px;">
        <button onclick="closeChat()" style="background:none; border:none; color:#fff; font-size:24px;">✕</button>
    </div>
    <div class="pseudo-screen" id="pseudoScreen">
      <h2>Rejoins le chat !</h2>
      <input class="pseudo-input" id="pseudoInput" type="text" placeholder="Ton pseudo..." maxlength="20">
      <button class="btn-join" onclick="joinChat()">Rejoindre et Activer Notifs</button>
    </div>
    <div class="chat-body" id="chatBody">
      <div class="messages-list" id="messagesList"></div>
      <div class="chat-input-row">
        <input class="chat-input" id="msgInput" type="text" placeholder="Message...">
        <button class="send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <div id="app">
    <div class="top-bar">
      <div class="header-container">
        <div class="live-badge">● LIVE</div>
        <div class="radio-ticker"><span>100% Hip-Hop Classic - Shade Radio</span></div>
      </div>
      <div class="hamburger-btn" id="hamburgerBtn" onclick="toggleMenu()">
        <span></span><span></span><span></span>
      </div>
    </div>
    <div class="main-frame">
      <img src="assets/logo2.PNG" alt="SHADE RADIO" class="radio-logo">
      <div class="player-container">
        <img src="assets/disque.PNG" class="custom-vinyl" alt="Vinyl">
        <div id="sc-player" is="player" api-url="https://manager11.streamradio.fr:1700/api/v2" station-name="SHADE RADIO"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- CONFIGURATION ---
    const SUPA_URL = 'https://rxhyapahjaypeudletdy.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4aHlhcGFoamF5cGV1ZGxldGR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ5MjYsImV4cCI6MjA4NzYxMDkyNn0.tkvyJVBP1PW5UKh8Kewwft0L-iTZzddx6QXBiNbvB_0';
    const VAPID_PUBLIC_KEY = 'BH2RMI_r3pIOu5WK6n7aTtzF25uWNFxk4AjypiIqn6x2SgtP7_mOyCw4i0a4N3yLe7ypsSd07v8N__-6-6tfirk';
    
    const sb = window.supabase.createClient(SUPA_URL, SUPA_KEY);
    let myPseudo = localStorage.getItem('shade_pseudo');

    // --- NOTIFICATIONS PUSH ---
    async function setupPushNotifications() {
      if ('serviceWorker' in navigator && 'PushManager' in window) {
        try {
          const reg = await navigator.serviceWorker.register('sw.js');
          const sub = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: VAPID_PUBLIC_KEY
          });

          await sb.from('push_subscriptions').upsert({ 
            subscription: sub, 
            pseudo: myPseudo 
          }, { onConflict: 'subscription' });
          
          console.log("Abonnement Push réussi !");
        } catch (e) { console.error("Erreur Push:", e); }
      }
    }

    // --- LOGIQUE CHAT ---
    function openChat() { 
        document.getElementById('chatOverlay').classList.add('open'); 
        if(myPseudo) showChatInterface();
    }
    function closeChat() { document.getElementById('chatOverlay').classList.remove('open'); }
    function toggleMenu() { document.getElementById('menuOverlay').classList.toggle('open'); }

    function joinChat() {
      const val = document.getElementById('pseudoInput').value.trim();
      if(!val) return;
      myPseudo = val;
      localStorage.setItem('shade_pseudo', val);
      showChatInterface();
      setupPushNotifications(); // Active les notifs à ce moment
    }

    function showChatInterface() {
      document.getElementById('pseudoScreen').style.display = 'none';
      document.getElementById('chatBody').classList.add('show');
      loadMessages();
      subscribeToMessages();
    }

    async function loadMessages() {
      const { data } = await sb.from('messages').select('*').order('created_at', { ascending: false }).limit(20);
      const list = document.getElementById('messagesList');
      list.innerHTML = '';
      data?.reverse().forEach(m => addMessageToUI(m));
      list.scrollTop = list.scrollHeight;
    }

    function subscribeToMessages() {
      sb.channel('public:messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
        addMessageToUI(payload.new);
      }).subscribe();
    }

    function addMessageToUI(m) {
      const list = document.getElementById('messagesList');
      const div = document.createElement('div');
      div.style.padding = "5px 10px";
      div.style.color = "#fff";
      div.innerHTML = `<strong>${m.pseudo}:</strong> ${m.content}`;
      list.appendChild(div);
      list.scrollTop = list.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById('msgInput');
      const content = input.value.trim();
      if(!content) return;
      await sb.from('messages').insert([{ pseudo: myPseudo, content: content }]);
      input.value = '';
    }
  </script>
</body>
</html>

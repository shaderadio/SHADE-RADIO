<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>SHADE RADIO – Live</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="assets/logo.JPG">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#000000">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; font-family: Arial, sans-serif; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { background: #000; color: #fff; display: flex; justify-content: center; min-height: 100vh; overflow: hidden; position: relative; }
    body::before { content: ""; position: fixed; inset: 0; background: radial-gradient(circle at 50% 40%, rgba(220,0,0,0.4), transparent 70%); z-index: -1; }
    #app { width: 100%; max-width: 420px; display: flex; flex-direction: column; align-items: center; padding: 10px; }
    .top-bar { display: flex; align-items: center; gap: 10px; width: 100%; margin-bottom: 10px; }
    .header-container { flex: 1; display: flex; align-items: center; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; overflow: hidden; }
    .live-badge { background: #ff0000; color: #fff; font-size: 11px; font-weight: bold; padding: 10px 12px; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    .radio-ticker { flex: 1; overflow: hidden; white-space: nowrap; }
    .radio-ticker span { display: inline-block; padding-left: 100%; animation: scroll 15s linear infinite; font-size: 12px; }
    @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    .hamburger-btn { cursor: pointer; background: rgba(255,0,0,0.2); padding: 10px; border-radius: 10px; border: 1px solid rgba(255,0,0,0.4); }
    .hamburger-btn span { display: block; width: 20px; height: 2px; background: #fff; margin: 4px 0; }
    .main-frame { background: rgba(255,255,255,0.03); backdrop-filter: blur(20px); border-radius: 40px; padding: 20px; width: 100%; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
    .radio-logo { width: 80%; max-width: 250px; margin-bottom: 20px; filter: drop-shadow(0 0 15px rgba(255,0,0,0.3)); }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; visibility: hidden; opacity: 0; transition: 0.3s; }
    .overlay.open { visibility: visible; opacity: 1; }
    .pseudo-input { width: 80%; padding: 15px; border-radius: 30px; border: 1px solid #ff0000; background: #222; color: #fff; margin-bottom: 20px; text-align: center; }
    .btn-join { background: #ff0000; color: #fff; border: none; padding: 15px 40px; border-radius: 30px; font-weight: bold; cursor: pointer; }
    .chat-body { width: 100%; height: 100%; display: none; flex-direction: column; }
    .chat-body.show { display: flex; }
    .messages-list { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
    .chat-input-row { display: flex; padding: 15px; gap: 10px; background: rgba(0,0,0,0.5); }
    .chat-input { flex: 1; padding: 12px; border-radius: 20px; background: #333; color: #fff; border: none; }
  </style>
</head>
<body>

  <div class="overlay" id="chatOverlay">
    <div style="width:100%; text-align:right; padding: 20px;">
        <button onclick="closeChat()" style="background:none; border:none; color:#fff; font-size:24px;">✕</button>
    </div>
    <div id="pseudoScreen">
      <h2 style="margin-bottom:20px;">Rejoindre le Live Chat</h2>
      <input class="pseudo-input" id="pseudoInput" type="text" placeholder="Ton pseudo..." maxlength="15">
      <button class="btn-join" onclick="joinChat()">ACTIVER NOTIFS & ENTRER</button>
    </div>
    <div class="chat-body" id="chatBody">
      <div class="messages-list" id="messagesList"></div>
      <div class="chat-input-row">
        <input class="chat-input" id="msgInput" type="text" placeholder="Ecrire...">
        <button onclick="sendMessage()" style="background:#ff0000; border:none; width:45px; border-radius:50%; color:#fff;"><i class="fas fa-paper-plane"></i></button>
      </div>
    </div>
  </div>

  <div id="app">
    <div class="top-bar">
      <div class="header-container">
        <div class="live-badge">● LIVE</div>
        <div class="radio-ticker"><span>SHADE RADIO - 100% CLASSIC HIP-HOP - SHADE RADIO</span></div>
      </div>
      <div class="hamburger-btn" onclick="openChat()">
        <span></span><span></span><span></span>
      </div>
    </div>
    <div class="main-frame">
      <img src="assets/logo2.PNG" class="radio-logo" alt="Logo">
      <div id="sc-player" is="player" api-url="https://manager11.streamradio.fr:1700/api/v2" station-name="SHADE RADIO"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- CONFIG ---
    const SUPA_URL = 'https://rxhyapahjaypeudletdy.supabase.co';
    const SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ4aHlhcGFoamF5cGV1ZGxldGR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzQ5MjYsImV4cCI6MjA4NzYxMDkyNn0.tkvyJVBP1PW5UKh8Kewwft0L-iTZzddx6QXBiNbvB_0';
    const VAPID_PUBLIC_KEY = 'BH2RMI_r3pIOu5WK6n7aTtzF25uWNFxk4AjypiIqn6x2SgtP7_mOyCw4i0a4N3yLe7ypsSd07v8N__-6-6tfirk';

    const sb = window.supabase.createClient(SUPA_URL, SUPA_KEY);
    let myPseudo = localStorage.getItem('shade_pseudo');

    // --- UTILS ---
    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) { outputArray[i] = rawData.charCodeAt(i); }
      return outputArray;
    }

    // --- PUSH NOTIFICATIONS ---
    async function setupPush() {
      if ('serviceWorker' in navigator) {
        try {
          const reg = await navigator.serviceWorker.register('sw.js');
          const sub = await reg.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
          });
          await sb.from('push_subscriptions').upsert({ subscription: sub, pseudo: myPseudo });
          console.log("Push OK");
        } catch (e) { console.error("Erreur Push:", e); }
      }
    }

    // --- UI ACTIONS ---
    function openChat() { 
      document.getElementById('chatOverlay').classList.add('open'); 
      if(myPseudo) showChat();
    }
    function closeChat() { document.getElementById('chatOverlay').classList.remove('open'); }

    function joinChat() {
      const val = document.getElementById('pseudoInput').value.trim();
      if(!val) return alert("Choisis un pseudo !");
      myPseudo = val;
      localStorage.setItem('shade_pseudo', val);
      showChat();
      setupPush();
    }

    function showChat() {
      document.getElementById('pseudoScreen').style.display = 'none';
      document.getElementById('chatBody').classList.add('show');
      loadMsgs();
      sb.channel('msgs').on('postgres_changes', {event:'INSERT', schema:'public', table:'messages'}, p => addMsg(p.new)).subscribe();
    }

    async function loadMsgs() {
      const { data } = await sb.from('messages').select('*').order('created_at', {ascending:false}).limit(30);
      data?.reverse().forEach(m => addMsg(m));
    }

    function addMsg(m) {
      const list = document.getElementById('messagesList');
      const d = document.createElement('div');
      d.innerHTML = `<span style="color:#ff0000;font-weight:bold;">${m.pseudo}:</span> ${m.content}`;
      list.appendChild(d);
      list.scrollTop = list.scrollHeight;
    }

    async function sendMessage() {
      const el = document.getElementById('msgInput');
      if(!el.value.trim()) return;
      await sb.from('messages').insert({ pseudo: myPseudo, content: el.value.trim() });
      el.value = '';
    }
  </script>
</body>
</html>
